pytest tests/test_entity_recognition.py -v -s        
======================================== test session starts =========================================
platform darwin -- Python 3.10.14, pytest-8.3.4, pluggy-1.5.0 -- /Users/jiandong/opt/anaconda3/envs/medkg/bin/python
cachedir: .pytest_cache
rootdir: /Users/jiandong/workspace/cclab/合作-北医三院/project/202502-medical-graphrag
configfile: pytest.ini
plugins: anyio-4.8.0, mock-3.14.0
collected 5 items                                                                                    

tests/test_entity_recognition.py::test_entity_recognition[input/entity_recognition_input_1.json-output/entity_recognition_output_1.json] 
------------------------------------------- live log call --------------------------------------------
2025-02-21 12:35:03 [    INFO] HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK" (_client.py:1025)
2025-02-21 12:35:11 [    INFO] HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK" (_client.py:1025)
2025-02-21 12:35:17 [    INFO] POST http://localhost:9200/drugs/_search [status:200 duration:0.024s] (_transport.py:349)
2025-02-21 12:35:17 [    INFO] POST http://localhost:9200/diseases/_search [status:200 duration:0.008s] (_transport.py:349)

原始输入数据:
{
  "description": "患者因发热、咽痛就诊，考虑急性链球菌性咽炎，拟使用阿莫西林治疗。",
  "patient_info": {
    "age": 35,
    "gender": "男",
    "symptoms": [
      "发热",
      "咽痛"
    ],
    "duration": "3天"
  },
  "prescription": {
    "drug": "阿莫西林",
    "dosage": "0.5g",
    "frequency": "每日三次",
    "duration": "3天"
  }
}

生成的Prompt:
请从以下医疗记录中识别所有的药品和疾病实体。

医疗记录：
{"description": "患者因发热、咽痛就诊，考虑急性链球菌性咽炎，拟使用阿莫西林治疗。", "patient_info": {"age": 35, "gender": "男", "symptoms": ["发热", "咽痛"], "duration": "3天"}, "prescription": {"drug": "阿莫西林", "dosage": "0.5g", "frequency": "每日三次", "duration": "3天"}}

请以JSON格式返回识别结果，包含以下字段：
{
    "drugs": [
        {
            "name": "药品名称1"
        },
        {
            "name": "药品名称2"
        }
    ],
    "diseases": [
        {
            "name": "疾病名称1"
        },
        {
            "name": "疾病名称2"
        }
    ],
    "context": {
        "description": "相关描述"
    }
}

在返回结果之前，请先用<think>标签记录你的思考过程。

原始LLM响应:
```json
{
    "drugs": [
        {
            "name": "阿莫西林"
        }
    ],
    "diseases": [
        {
            "name": "急性链球菌性咽炎"
        }
    ],
    "context": {
        "description": "患者因发热、咽痛就诊，考虑急性链球菌性咽炎，拟使用阿莫西林治疗。"
    }
}
```

测试输入文件: input/entity_recognition_input_1.json
识别结果:
药品: [RecognizedDrug(name='阿莫西林', matches=[DrugMatch(id='f675e7141ab0401189254746e41dc2a8', standard_name='阿莫西林片', score=16.188377)])]
疾病: [RecognizedDisease(name='急性链球菌性咽炎', matches=[DiseaseMatch(id='disease_1759', standard_name='化脓性链球菌咽炎', score=16.509794)])]
上下文: Context(description='患者因发热、咽痛就诊，考虑急性链球菌性咽炎，拟使用阿莫西林治疗。', raw_data={'description': '患者因发热、咽痛就诊，考虑急性链球菌性咽炎，拟使用阿莫西林治疗。', 'patient_info': {'age': 35, 'gender': '男', 'symptoms': ['发热', '咽痛'], 'duration': '3天'}, 'prescription': {'drug': '阿莫西林', 'dosage': '0.5g', 'frequency': '每日三次', 'duration': '3天'}})
附加信息: {'think': ''}

PASSED
tests/test_entity_recognition.py::test_entity_recognition[input/entity_recognition_input_2.json-output/entity_recognition_output_2.json] 
------------------------------------------- live log call --------------------------------------------
2025-02-21 12:35:18 [    INFO] HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK" (_client.py:1025)
2025-02-21 12:35:26 [    INFO] HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK" (_client.py:1025)
2025-02-21 12:35:37 [    INFO] POST http://localhost:9200/drugs/_search [status:200 duration:0.022s] (_transport.py:349)
2025-02-21 12:35:37 [    INFO] POST http://localhost:9200/diseases/_search [status:200 duration:0.008s] (_transport.py:349)
2025-02-21 12:35:37 [    INFO] POST http://localhost:9200/diseases/_search [status:200 duration:0.009s] (_transport.py:349)

原始输入数据:
{
  "description": "患者诊断为继发性肺动脉高压，拟使用西地那非治疗。患者有明显的呼吸困难和活动耐量下降症状。",
  "patient_info": {
    "age": 45,
    "gender": "女",
    "symptoms": [
      "呼吸困难",
      "活动耐量下降",
      "心悸"
    ],
    "duration": "2个月",
    "comorbidities": [
      "系统性硬化症"
    ]
  },
  "prescription": {
    "drug": "西地那非",
    "dosage": "20mg",
    "frequency": "每日三次",
    "duration": "长期",
    "notes": "需要定期监测血压和心功能"
  }
}

生成的Prompt:
请从以下医疗记录中识别所有的药品和疾病实体。

医疗记录：
{"description": "患者诊断为继发性肺动脉高压，拟使用西地那非治疗。患者有明显的呼吸困难和活动耐量下降症状。", "patient_info": {"age": 45, "gender": "女", "symptoms": ["呼吸困难", "活动耐量下降", "心悸"], "duration": "2个月", "comorbidities": ["系统性硬化症"]}, "prescription": {"drug": "西地那非", "dosage": "20mg", "frequency": "每日三次", "duration": "长期", "notes": "需要定期监测血压和心功能"}}

请以JSON格式返回识别结果，包含以下字段：
{
    "drugs": [
        {
            "name": "药品名称1"
        },
        {
            "name": "药品名称2"
        }
    ],
    "diseases": [
        {
            "name": "疾病名称1"
        },
        {
            "name": "疾病名称2"
        }
    ],
    "context": {
        "description": "相关描述"
    }
}

在返回结果之前，请先用<think>标签记录你的思考过程。

原始LLM响应:
```json
{
    "drugs": [
        {
            "name": "西地那非"
        }
    ],
    "diseases": [
        {
            "name": "继发性肺动脉高压"
        },
        {
            "name": "系统性硬化症"
        }
    ],
    "context": {
        "description": "患者诊断为继发性肺动脉高压，拟使用西地那非治疗。患者有明显的呼吸困难和活动耐量下降症状。"
    }
}
```

测试输入文件: input/entity_recognition_input_2.json
识别结果:
药品: [RecognizedDrug(name='西地那非', matches=[DrugMatch(id='adaaac9dea734e038d7ece33fdd1a8da', standard_name='枸橼酸西地那非片', score=15.017281)])]
疾病: [RecognizedDisease(name='继发性肺动脉高压', matches=[DiseaseMatch(id='disease_823', standard_name='肺动脉高压', score=19.924986)]), RecognizedDisease(name='系统性硬化症', matches=[DiseaseMatch(id='disease_996', standard_name='消化系统感染', score=12.238672)])]
上下文: Context(description='患者诊断为继发性肺动脉高压，拟使用西地那非治疗。患者有明显的呼吸困难和活动耐量下降症状。', raw_data={'description': '患者诊断为继发性肺动脉高压，拟使用西地那非治疗。患者有明显的呼吸困难和活动耐量下降症状。', 'patient_info': {'age': 45, 'gender': '女', 'symptoms': ['呼吸困难', '活动耐量下降', '心悸'], 'duration': '2个月', 'comorbidities': ['系统性硬化症']}, 'prescription': {'drug': '西地那非', 'dosage': '20mg', 'frequency': '每日三次', 'duration': '长期', 'notes': '需要定期监测血压和心功能'}})
附加信息: {'think': ''}

PASSED
tests/test_entity_recognition.py::test_entity_recognition_error 
------------------------------------------- live log call --------------------------------------------
2025-02-21 12:35:38 [    INFO] HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK" (_client.py:1025)
2025-02-21 12:35:44 [    INFO] HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK" (_client.py:1025)
2025-02-21 12:35:55 [    INFO] POST http://localhost:9200/drugs/_search [status:200 duration:0.031s] (_transport.py:349)
2025-02-21 12:35:55 [    INFO] POST http://localhost:9200/diseases/_search [status:200 duration:0.004s] (_transport.py:349)

原始输入数据:
{
  "description": "患者出现不明原因的症状，考虑使用新型药物治疗。",
  "patient_info": {
    "age": 50,
    "gender": "男",
    "symptoms": [
      "未知症状"
    ],
    "duration": "1周"
  },
  "prescription": {
    "drug": "未知药物X",
    "dosage": "10mg",
    "frequency": "每日一次",
    "duration": "1周"
  }
}

生成的Prompt:
请从以下医疗记录中识别所有的药品和疾病实体。

医疗记录：
{"description": "患者出现不明原因的症状，考虑使用新型药物治疗。", "patient_info": {"age": 50, "gender": "男", "symptoms": ["未知症状"], "duration": "1周"}, "prescription": {"drug": "未知药物X", "dosage": "10mg", "frequency": "每日一次", "duration": "1周"}}

请以JSON格式返回识别结果，包含以下字段：
{
    "drugs": [
        {
            "name": "药品名称1"
        },
        {
            "name": "药品名称2"
        }
    ],
    "diseases": [
        {
            "name": "疾病名称1"
        },
        {
            "name": "疾病名称2"
        }
    ],
    "context": {
        "description": "相关描述"
    }
}

在返回结果之前，请先用<think>标签记录你的思考过程。

原始LLM响应:
```json
{
    "drugs": [
        {
            "name": "未知药物X"
        }
    ],
    "diseases": [],
    "context": {
        "description": "患者出现不明原因的症状，考虑使用新型药物治疗。"
    }
}
```

测试错误处理:
识别到的药品: [RecognizedDrug(name='未知药物X', matches=[DrugMatch(id='e8871cc7-0550-11ea-8b07-acde4800', standard_name='知母', score=8.6752405)])]
识别到的疾病: [RecognizedDisease(name='未知疾病Y', matches=[DiseaseMatch(id='disease_1881', standard_name='未明确的疾病', score=11.132277)])]
上下文: Context(description='患者出现不明原因的症状，考虑使用新型药物治疗。', raw_data={'description': '患者出现不明原因的症状，考虑使用新型药物治疗。', 'patient_info': {'age': 50, 'gender': '男', 'symptoms': ['未知症状'], 'duration': '1周'}, 'prescription': {'drug': '未知药物X', 'dosage': '10mg', 'frequency': '每日一次', 'duration': '1周'}})
附加信息: {'think': ''}

PASSED
tests/test_entity_recognition.py::test_invalid_input 
------------------------------------------- live log call --------------------------------------------
2025-02-21 12:35:55 [   ERROR] 识别实体时发生错误: 输入数据必须包含非空的description字段 (entity_recognition.py:256)

原始输入数据:
{
  "description": ""
}

测试无效输入: 成功抛出 ValueError

PASSED
tests/test_entity_recognition.py::test_think_content 
------------------------------------------- live log call --------------------------------------------
2025-02-21 12:35:55 [    INFO] HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK" (_client.py:1025)
2025-02-21 12:36:03 [    INFO] HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK" (_client.py:1025)

原始输入数据:
{
  "description": "测试think内容"
}

生成的Prompt:
请从以下医疗记录中识别所有的药品和疾病实体。

医疗记录：
{"description": "测试think内容"}

请以JSON格式返回识别结果，包含以下字段：
{
    "drugs": [
        {
            "name": "药品名称1"
        },
        {
            "name": "药品名称2"
        }
    ],
    "diseases": [
        {
            "name": "疾病名称1"
        },
        {
            "name": "疾病名称2"
        }
    ],
    "context": {
        "description": "相关描述"
    }
}

在返回结果之前，请先用<think>标签记录你的思考过程。

原始LLM响应:
```json
{
    "drugs": [
        {
            "name": ""
        }
    ],
    "diseases": [
        {
            "name": ""
        }
    ],
    "context": {
        "description": "测试think内容"
    }
}
```

测试 think 内容:
Think 内容: 

PASSED

==================================== 5 passed in 65.02s (0:01:05) ====================================