pytest tests/test_indication_analysis.py -v -s
======================================== test session starts =========================================
platform darwin -- Python 3.10.14, pytest-8.3.4, pluggy-1.5.0 -- /Users/jiandong/opt/anaconda3/envs/medkg/bin/python
cachedir: .pytest_cache
rootdir: /Users/jiandong/workspace/cclab/合作-北医三院/project/202502-medical-graphrag
configfile: pytest.ini
plugins: anyio-4.8.0, mock-3.14.0
collected 2 items                                                                                    

tests/test_indication_analysis.py::test_indication_analysis_case1 
------------------------------------------- live log call --------------------------------------------
2025-02-21 12:12:58 [    INFO] GET http://localhost:9200/drugs/_doc/f675e7141ab0401189254746e41dc2a8 [status:200 duration:0.006s] (_transport.py:349)
2025-02-21 12:12:58 [    INFO] GET http://localhost:9200/diseases/_doc/disease_1759 [status:200 duration:0.002s] (_transport.py:349)
2025-02-21 12:12:58 [    INFO] POST http://localhost:9200/clinical_guidelines/_search [status:404 duration:0.003s] (_transport.py:349)
2025-02-21 12:12:58 [ WARNING] 临床指南索引不存在: clinical_guidelines (knowledge_enhancer.py:141)
2025-02-21 12:12:58 [    INFO] POST http://localhost:9200/expert_consensus/_search [status:404 duration:0.002s] (_transport.py:349)
2025-02-21 12:12:58 [ WARNING] 专家共识索引不存在: expert_consensus (knowledge_enhancer.py:164)
2025-02-21 12:12:58 [    INFO] POST http://localhost:9200/research_papers/_search [status:404 duration:0.002s] (_transport.py:349)
2025-02-21 12:12:58 [ WARNING] 研究文献索引不存在: research_papers (knowledge_enhancer.py:187)
2025-02-21 12:12:59 [    INFO] HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK" (_client.py:1025)
2025-02-21 12:13:07 [    INFO] GET http://localhost:9200/drugs/_doc/f675e7141ab0401189254746e41dc2a8 [status:200 duration:0.004s] (_transport.py:349)
2025-02-21 12:13:07 [    INFO] GET http://localhost:9200/diseases/_doc/disease_1759 [status:200 duration:0.002s] (_transport.py:349)
2025-02-21 12:13:07 [    INFO] POST http://localhost:9200/clinical_guidelines/_search [status:404 duration:0.002s] (_transport.py:349)
2025-02-21 12:13:07 [ WARNING] 临床指南索引不存在: clinical_guidelines (knowledge_enhancer.py:141)
2025-02-21 12:13:07 [    INFO] POST http://localhost:9200/expert_consensus/_search [status:404 duration:0.003s] (_transport.py:349)
2025-02-21 12:13:07 [ WARNING] 专家共识索引不存在: expert_consensus (knowledge_enhancer.py:164)
2025-02-21 12:13:07 [    INFO] POST http://localhost:9200/research_papers/_search [status:404 duration:0.002s] (_transport.py:349)
2025-02-21 12:13:07 [ WARNING] 研究文献索引不存在: research_papers (knowledge_enhancer.py:187)
2025-02-21 12:13:07 [    INFO] HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK" (_client.py:1025)

=== Case 1 ===

1. 输入数据:
{
  "drugs": [
    {
      "name": "阿莫西林",
      "matches": [
        {
          "id": "f675e7141ab0401189254746e41dc2a8",
          "standard_name": "阿莫西林片",
          "score": 16.188377
        }
      ]
    }
  ],
  "diseases": [
    {
      "name": "急性链球菌性咽炎",
      "matches": [
        {
          "id": "disease_1759",
          "standard_name": "化脓性链球菌咽炎",
          "score": 16.509794
        }
      ]
    }
  ],
  "context": {
    "description": "患者因发热、咽痛就诊，考虑急性链球菌性咽炎，拟使用阿莫西林治疗。",
    "raw_data": {
      "description": "患者因发热、咽痛就诊，考虑急性链球菌性咽炎，拟使用阿莫西林治疗。",
      "patient_info": {
        "age": 35,
        "gender": "男",
        "symptoms": [
          "发热",
          "咽痛"
        ],
        "duration": "3天"
      },
      "prescription": {
        "drug": "阿莫西林",
        "dosage": "0.5g",
        "frequency": "每日三次",
        "duration": "3天"
      }
    }
  },
  "additional_info": {
    "think": null
  }
}

2. 创建的 Case 对象:
Case ID: case_20250221121258
Drugs: ['阿莫西林']
Diseases: ['急性链球菌性咽炎']
Context: 患者因发热、咽痛就诊，考虑急性链球菌性咽炎，拟使用阿莫西林治疗。

3. 知识增强后的 Case 信息:
药品信息:
- 名称: 阿莫西林片
- 标准名称: None
- 适应症: ['阿莫西林适用于敏感菌不产β内酰胺酶菌株所致的下列感染： 1.溶血链球菌、肺炎链球菌、葡萄球菌或流感嗜血杆菌所致中耳炎、鼻窦炎、咽炎、扁桃体炎等上呼吸道感染', '2.大肠埃希菌、奇异变形杆菌或粪肠球菌所致的泌尿生殖道感染', '3.溶血链球菌、葡萄球菌或大肠埃希菌所致的皮肤软组织感染', '4.溶血链球菌、肺炎链球菌、葡萄球菌或流感嗜血杆菌所致急性支气管炎、肺炎等下呼吸道感染', '5.急性单纯性淋病', '6.本品尚可用于治疗伤寒、伤寒带菌者及钩端螺旋体病', '阿莫西林亦可与克拉霉素、兰索拉唑三联用药根除胃、十二指肠幽门螺旋杆菌，降低消化道溃疡复发率']
- 禁忌症: ['青霉素过敏及青霉素皮肤试验阳性患者禁用']
- 注意事项: ['1. 青霉素类口服药物偶可引起过敏性休克，尤多见于有青霉素或头孢菌素过敏史患者', '用药前必须详细询问药物过敏史并做 青霉素皮肤试验', '如发生过敏性休克，应就地抢救，予以保持气道畅通、吸氧及肾上腺素、糖皮质激素等治疗措施', '2. 传染性单核细胞增多症患者应用本品易发生皮疹，应避免使用', '3. 疗程较长患者应检查肝、肾功能和血常规', '4.阿莫西林可导致采用Benedif或Fehling试剂的尿糖试验出现假阳性', '5.下列情况下应慎用： 1有哮喘、枯草热等过敏性疾病史者', '2老年人和肾功能严重损害时可能须调整剂量']

疾病信息:
- 名称: 化脓性链球菌咽炎
- 标准名称: None
- ICD编码: None

4. 规则分析结果:
{
  "is_offlabel": true,
  "confidence": 0.0,
  "reasoning": [],
  "evidence": []
}

5. 生成的提示:
请分析以下用药情况是否属于超适应症用药。

输入信息：
1. 药品信息：
   - 名称：阿莫西林片
   - 标准适应症：["阿莫西林适用于敏感菌不产β内酰胺酶菌株所致的下列感染： 1.溶血链球菌、肺炎链球菌、葡萄球菌或流感嗜血杆菌所致中耳炎、鼻窦炎、咽炎、扁桃体炎等上呼吸道感染", "2.大肠埃希菌、奇异变形杆菌或粪肠球菌所致的泌尿生殖道感染", "3.溶血链球菌、葡萄球菌或大肠埃希菌所致的皮肤软组织感染", "4.溶血链球菌、肺炎链球菌、葡萄球菌或流感嗜血杆菌所致急性支气管炎、肺炎等下呼吸道感染", "5.急性单纯性淋病", "6.本品尚可用于治疗伤寒、伤寒带菌者及钩端螺旋体病", "阿莫西林亦可与克拉霉素、兰索拉唑三联用药根除胃、十二指肠幽门螺旋杆菌，降低消化道溃疡复发率"]
   - 药理毒理：无相关信息
   - 禁忌：["青霉素过敏及青霉素皮肤试验阳性患者禁用"]
   - 注意事项：["1. 青霉素类口服药物偶可引起过敏性休克，尤多见于有青霉素或头孢菌素过敏史患者", "用药前必须详细询问药物过敏史并做 青霉素皮肤试验", "如发生过敏性休克，应就地抢救，予以保持气道畅通、吸氧及肾上腺素、糖皮质激素等治疗措施", "2. 传染性单核细胞增多症患者应用本品易发生皮疹，应避免使用", "3. 疗程较长患者应检查肝、肾功能和血常规", "4.阿莫西林可导致采用Benedif或Fehling试剂的尿糖试验出现假阳性", "5.下列情况下应慎用： 1有哮喘、枯草热等过敏性疾病史者", "2老年人和肾功能严重损害时可能须调整剂量"]

2. 患者情况：
   - 诊断：化脓性链球菌咽炎
   - 详细描述：患者因发热、咽痛就诊，考虑急性链球菌性咽炎，拟使用阿莫西林治疗。

3. 规则分析结果：
   {"is_offlabel": true, "confidence": 0.0, "reasoning": [], "evidence": []}

4. 临床指南：
   （数据不可用）
   []

5. 专家共识：
   （数据不可用）
   []

6. 研究证据：
   （数据不可用）
   []

注意事项：
1. 对于标记为"（数据不可用）"的信息，请在分析中明确指出缺少该类数据，并解释这可能如何影响您的判断。
2. 在证据等级评估时，如果某类证据缺失，应相应降低整体评估的可信度。
3. 即使缺少部分数据，也请尽可能基于现有信息给出合理的分析和建议。
4. 在结果中，请明确指出哪些结论是基于完整数据得出的，哪些是在数据缺失情况下的推测。

请按照以下格式返回分析结果（注意：必须是合法的JSON格式，不要添加任何注释或说明）：

{
  "is_offlabel": false,
  "confidence": 0.85,
  "analysis": {
    "indication_match": {
      "score": 0.9,
      "matching_indication": "标准适应症名称",
      "reasoning": "匹配度分析原因"
    },
    "mechanism_similarity": {
      "score": 0.8,
      "reasoning": "机制相似性分析说明"
    },
    "evidence_support": {
      "level": "B",
      "description": "支持证据说明"
    }
  },
  "recommendation": {
    "decision": "建议使用",
    "explanation": "建议说明",
    "risk_assessment": "风险评估说明"
  },
  "data_limitations": {
    "missing_data": ["临床指南", "专家共识"],
    "impact_on_analysis": "数据缺失对分析的影响说明"
  }
}

6. 原始LLM响应:
            "matching_indication": "溶血链球菌、葡萄球菌或流感嗜血杆菌所致中耳炎、鼻窦炎、咽炎、扁桃体        "impact_on_analysis": "缺乏临床指南和专家共识可能影响对适应症外用药的判断，但基于现有信息，用}   } 。"


7. 清理后的LLM响应:
{"is_offlabel": false, "confidence": 0.85, "analysis": {"indication_match": {"score": 0.9, "matching_indication": "溶血链球菌、葡萄球菌或流感嗜血杆菌所致中耳炎、鼻窦炎、咽炎、扁桃体炎等上呼吸道感染", "reasoning": "患者诊断为化脓性链球菌咽炎，属于上呼吸道感染，符合阿莫西林的标准适应症。"}, "mechanism_similarity": {"score": 0.8, "reasoning": "阿莫西林针对革兰氏阳性菌如链球菌有效，与患者感染的病原体匹配。"}, "evidence_support": {"level": "B", "description": "虽然缺乏临床指南和专家共识，但基于药理学和适应症匹配，支持使用。"}}, "recommendation": {"decision": "建议使用", "explanation": "阿莫西林适用于治疗由敏感菌引起的上呼吸道感染，患者诊断符合标准适应症。", "risk_assessment": "需注意患者是否有青霉素过敏史，必要时进行皮肤试验。"}, "data_limitations": {"missing_data": ["临床指南", "专家共识", "研究证据"], "impact_on_analysis": "缺乏临床指南和专家共识可能影响对适应症外用药的判断，但基于现有信息，用药合理。"}}

8. 最终分析结果:
{
  "is_offlabel": true,
  "confidence": 0.49000000000000005,
  "analysis": {
    "indication_match": {
      "score": 0.18000000000000002,
      "matching_indication": "溶血链球菌或肺炎链球菌所致的咽炎",
      "reasoning": "患者诊断为化脓性链球菌咽炎，属于阿莫西林的标准适应症范围内的咽炎，由溶血链球菌引起。"
    },
    "mechanism_similarity": {
      "score": 0.8,
      "reasoning": "阿莫西林对化脓性链球菌有良好的抗菌活性，作用机制与标准适应症中的细菌感染相似。"
    },
    "evidence_support": {
      "level": "B",
      "description": "虽然缺乏临床指南和专家共识的支持，但基于药理学和适应症的匹配度，支持使用阿莫西林治疗该患者。"
    }
  },
  "recommendation": {
    "decision": "谨慎使用",
    "explanation": "虽然属于超适应症用药，但有一定的证据支持其合理性。建议在充分评估风险收益后决定是否使用。",
    "risk_assessment": "未发现明显风险，但仍需要注意监测不良反应。"
  },
  "evidence_synthesis": {
    "matching_indication": "溶血链球菌或肺炎链球菌所致的咽炎",
    "indication_match_reasoning": [
      "患者诊断为化脓性链球菌咽炎，属于阿莫西林的标准适应症范围内的咽炎，由溶血链球菌引起。"
    ],
    "mechanism_reasoning": [
      "阿莫西林对化脓性链球菌有良好的抗菌活性，作用机制与标准适应症中的细菌感染相似。"
    ],
    "evidence_level": "B",
    "evidence_description": [
      "虽然缺乏临床指南和专家共识的支持，但基于药理学和适应症的匹配度，支持使用阿莫西林治疗该患者。"
    ],
    "sources": []
  },
  "metadata": {
    "analysis_time": "2025-02-21T12:13:15.093646",
    "rule_confidence": 0.0,
    "llm_confidence": 0.85,
    "evidence_sources": []
  }
}

PASSED
tests/test_indication_analysis.py::test_indication_analysis_case2 
------------------------------------------- live log call --------------------------------------------
2025-02-21 12:13:15 [    INFO] GET http://localhost:9200/drugs/_doc/011af6f647be45958789e5abbf166933 [status:200 duration:0.007s] (_transport.py:349)
2025-02-21 12:13:15 [    INFO] GET http://localhost:9200/diseases/_doc/disease_823 [status:200 duration:0.004s] (_transport.py:349)
2025-02-21 12:13:15 [    INFO] POST http://localhost:9200/clinical_guidelines/_search [status:404 duration:0.002s] (_transport.py:349)
2025-02-21 12:13:15 [ WARNING] 临床指南索引不存在: clinical_guidelines (knowledge_enhancer.py:141)
2025-02-21 12:13:15 [    INFO] POST http://localhost:9200/expert_consensus/_search [status:404 duration:0.002s] (_transport.py:349)
2025-02-21 12:13:15 [ WARNING] 专家共识索引不存在: expert_consensus (knowledge_enhancer.py:164)
2025-02-21 12:13:15 [    INFO] POST http://localhost:9200/research_papers/_search [status:404 duration:0.002s] (_transport.py:349)
2025-02-21 12:13:15 [ WARNING] 研究文献索引不存在: research_papers (knowledge_enhancer.py:187)
2025-02-21 12:13:15 [    INFO] HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK" (_client.py:1025)
2025-02-21 12:13:18 [    INFO] GET http://localhost:9200/drugs/_doc/011af6f647be45958789e5abbf166933 [status:200 duration:0.005s] (_transport.py:349)
2025-02-21 12:13:18 [    INFO] GET http://localhost:9200/diseases/_doc/disease_823 [status:200 duration:0.003s] (_transport.py:349)
2025-02-21 12:13:18 [    INFO] POST http://localhost:9200/clinical_guidelines/_search [status:404 duration:0.003s] (_transport.py:349)
2025-02-21 12:13:18 [ WARNING] 临床指南索引不存在: clinical_guidelines (knowledge_enhancer.py:141)
2025-02-21 12:13:18 [    INFO] POST http://localhost:9200/expert_consensus/_search [status:404 duration:0.001s] (_transport.py:349)
2025-02-21 12:13:18 [ WARNING] 专家共识索引不存在: expert_consensus (knowledge_enhancer.py:164)
2025-02-21 12:13:18 [    INFO] POST http://localhost:9200/research_papers/_search [status:404 duration:0.001s] (_transport.py:349)
2025-02-21 12:13:18 [ WARNING] 研究文献索引不存在: research_papers (knowledge_enhancer.py:187)
2025-02-21 12:13:18 [    INFO] HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK" (_client.py:1025)

=== Case 2 ===

1. 输入数据:
{
  "drugs": [
    {
      "name": "西地那非",
      "matches": [
        {
          "id": "011af6f647be45958789e5abbf166933",
          "standard_name": "枸橼酸西地那非片",
          "score": 16.188377
        }
      ]
    }
  ],
  "diseases": [
    {
      "name": "继发性肺动脉高压",
      "matches": [
        {
          "id": "disease_823",
          "standard_name": "肺动脉高压",
          "score": 16.509794
        }
      ]
    }
  ],
  "context": {
    "description": "患者诊断为继发性肺动脉高压，拟使用西地那非治疗。患者有明显的呼吸困难和活动耐量下降症状。",
    "raw_data": {
      "description": "患者诊断为继发性肺动脉高压，拟使用西地那非治疗。患者有明显的呼吸困难和活动耐量下降症状。",
      "patient_info": {
        "age": 45,
        "gender": "女",
        "symptoms": [
          "呼吸困难",
          "活动耐量下降",
          "心悸"
        ],
        "duration": "2个月"
      },
      "prescription": {
        "drug": "西地那非",
        "dosage": "20mg",
        "frequency": "每日三次",
        "duration": "长期",
        "notes": "需要定期监测血压和心功能"
      }
    }
  },
  "additional_info": {
    "think": null
  }
}

2. 创建的 Case 对象:
Case ID: case_20250221121315
Drugs: ['西地那非']
Diseases: ['继发性肺动脉高压']
Context: 患者诊断为继发性肺动脉高压，拟使用西地那非治疗。患者有明显的呼吸困难和活动耐量下降症状。

3. 知识增强后的 Case 信息:
药品信息:
- 名称: 枸橼酸西地那非片
- 标准名称: None
- 适应症: ['西地那非适用于治疗勃起功能障碍']
- 禁忌症: ['硝酸酯类：由于已知的枸橼酸西地那非片对一氧化氮cGMP途径的作用见药理毒理，西地那非可增强硝酸酯的降压作用', '故服用一氧化氮供体例如任何形式的有机硝酸酯类或有机亚硝酸酯类的患者，无论是规律服用或间断服用，均为禁忌症', '禁止PDE5 抑制剂包括西地那非与鸟苷酸环化酶激动剂例如利奥西呱合用，因为这样可能会引起症状性低血压', '患者服用西地那非后，何时可以安全地服用硝酸酯类药物如需要目前尚不清楚', '根据健康志愿者药代动力学资料，单剂口服100mg，24 小时后血浆西地那非浓度约为2ngml峰值血药浓度约为440 ngml 见药代动力学', '以下患者服药24 小时后血浆西地那非浓度较健康志愿者高38 倍：年龄65 岁以上、肝损害如肝硬化、严重肾损害肌酐清除率30mlmin 以下、同时服用细胞色素P4503A4 的强抑制剂如红霉素等', '尽管服药24小时后的西地那非血药浓度远远低于峰浓度，但尚不了解此时是否可以安全地服用硝酸酯类药物', '已知对本品中任何成份过敏的患者禁用', '警告 心血管：性活动对已有心血管疾病患者的心脏有潜在危险', '因此，其心血管状态不宜进行性活动的患者一般不应使用包括西地那非在内的治疗勃起功能障碍的药物', '由于西地那非使体循环血管舒张，健康志愿者的仰卧位血压发生短暂的降低平均最大降幅8.45.5mmHg见药理毒理', '通常在大多数患者，此种影响的结果可以不计，但医师开处方前仍要仔细斟酌这种血管舒张效应是否会给伴有心血管疾病的患者带来不良的后果，尤其是在性活动时', '有下列潜在疾病的患者对包括西地那非在内的血管扩张剂的作用可能尤为敏感包括左心室流出道梗阻如主动脉狭窄，特发性肥厚性主动脉瓣下狭窄和伴有血压自主控制严重损害的疾病', '此类患者应谨慎用药', '目前，没有以下人群应用西地那非的安全性和有效性的临床对照试验资料', '对此类患者，处方须谨慎： 最近6个月内曾有心肌梗死、休克或危及生命的心律失常的患者', '静息状态低血压血压9050mmHg 以下或高血压血压170110mmHg 以上的患者', '有心力衰竭或冠心病不稳定性心绞痛的患者', '色素视网膜炎的患者少数此病患者有视网膜磷酸二酯酶的遗传性异常', '镰状细胞性贫血或相关贫血患者', '勃起时间延长和阴茎异常勃起：国外批准枸橼酸西地那非片上市后，有少量勃起时间延长超过4小时和异常勃起痛性勃起超过6小时的报告', '如持续勃起超过4小时，患者应立即就诊', '如异常勃起未得到即刻处理，阴茎组织将可能受到损害并可能导致永久性的勃起功能丧失', '以下疾病患者慎用西地那非：阴茎解剖畸形如阴茎偏曲、海绵体纤维化、Peyronie 氏病，易引起阴茎异常勃起的疾病如镰状细胞性贫血、多发性骨髓瘤、白血病', '但是，目前尚无本品在镰状细胞贫血或相关贫血患者中的安全性或有效性的对照临床数据', '与利托那韦合并用药导致的不良反应：同时服用蛋白酶抑制剂利托那韦 会显著增加西地那非的血药浓度AUC增加11 倍', '服用利托那韦的患者需慎用西地那非', '有关高血药浓度西地那非对受试者影响的资料很有限，仅知道视觉异常在高剂量时更常见', '某些服用高剂量西地那非200800mg的健康受试者报告了血压下降、晕厥和勃起时间延长', '为减少服用利托那韦的患者发生不良事件的可能性，建议减小其西地那非的用药剂量']
- 注意事项: ['一般事项 诊断勃起功能障碍的同时应明确其潜在的病因，进行全面的医学检查后确定适当的治疗方案', '在给患者应用西地那非之前，须注意以下一些重要问题： 与α受体阻滞剂或抗高血压药物合并用药时的低血压 α受体阻滞剂：PDE55型磷酸二酯酶抑制剂与α受体阻滞剂合用时需谨慎', 'PDE5抑制剂包括本品与α受体阻滞剂同为血管扩张剂，都具有降低血压的作用', '当合用血管扩张剂时，可以预期对血压的作用可能累加', '在部分患者中，这两类药物合用可显著降低血压，导致低血压症状如头晕、头昏、昏厥见药物相互作用', '还应注意以下情况： 患者接受西地那非治疗前，应已经达到α受体阻滞剂治疗稳定状态', '单独服用α受体阻滞剂治疗血流动力学不稳定的患者，合用PDE5抑制剂后发生低血压症状的风险增加', '接受α受体阻滞剂治疗已达稳定状态的患者，PDE5抑制剂应从最低剂量开始服用', '对于已经服用理想剂量PDE5抑制剂的患者，接受α受体阻滞剂治疗应从最低剂量开始', '同时服用PDE5抑制剂，随着α受体阻滞剂剂量的逐步增加，可能进一步降低血压', '联合应用PDE5抑制剂与α受体阻滞剂的安全性可能受其它因素的影响，包括血管内容量不足和其它抗高血压药物', '降压药物：西地那非使体循环血管扩张，可能增强其它抗高血压药物的降压作用', '在主要的临床试验中包括了同时服用多种抗高血压药物的患者', '另一个独立的药物相互作用研究显示，服用5mg或10mg氨氯地平的高血压患者加用枸橼酸西地那非片100mg量时，收缩压和舒张压平均进一步降低8mmHg和7mmHg见药物相互作用', '在三项药物相互作用的研究中，接受多沙唑嗪治疗达稳定状态的良性前列腺增生BPH患者同时服用α受体阻滞剂多沙唑嗪4mg和8 mg和西地那非25mg、50mg 或100mg，在这些研究人群中，观察到仰卧位血压平均各进一步降低77mmHg、95mmHg 和84mmHg，而立位血压平均各进一步降低66mmHg、114mmHg 和45mmHg', '如同时服用更大剂量西地那非和多沙唑嗪4mg，在服药后14 小时内有个别患者出现体位性低血压症状的报告，包括头晕、头晕目眩，而无晕厥', '给予α 受体阻滞剂治疗的患者同时服用西地那非可能会在一些患者中引起低血压症状', '因此，西地那非剂量如超过25mg，不应在服用α受体阻滞剂4 小时之内服用', '安全性数据库分析显示，西地那非与或不与降压药物同服，患者的副作用无差异', '上市后经验，有与西地那非相关的勃起时间延长和异常勃起的报告', '如持续勃起超过4 小时，患者应立即就诊', '如异常勃起未得到即刻处理，阴茎组织将可能受到损害并可能导致永久性的勃起功能丧失', '与其他PDE5 抑制剂或其他勃起功能障碍治疗合并用药：其他PDE5 抑制剂，或含有西地那非的其他肺动脉高压PAH治疗药物Revatio，或者其他勃起功能障碍的治疗方法与本品合用的安全性和有效性尚未经研究', '此类联合用药可能会进一步降低血压', '故不推荐联合使用', '对出血的影响：在曾服用枸橼酸西地那非片的患者中，曾有过上市后出血事件的报道', '本品与这些事件之间的因果关系尚未确立', '无论单独使用或与阿司匹林合用，枸橼酸西地那非片对人出血时间没有影响', '然而，体外实验中，枸橼酸西地那非片增强硝普钠一种一氧化氮供体的抗人类血小板凝聚作用', '此外，在麻醉下的家兔，肝素与西地那非合用对出血时间的延长有叠加作用，但未进行过类似的人体研究', '目前未知枸橼酸西地那非片在出血性疾病患者和活动性消化道溃疡患者中的安全性', '患者须知 医生应给患者讲解禁止西地那非与硝酸酯同时服用无论后者是规律还是间断用药', '医生应告知患者，西地那非有增强α受体阻滞剂和其它抗高血压药物降压作用的潜在可能', '同时服用西地那非和α受体阻滞剂可能会引起一些患者的低血压症状', '需要合并使用西地那非与α受体阻滞剂时，西地那非治疗前，患者应已经达到α受体阻滞剂治疗稳定状态，并且西地那非应该从最低剂量开始服用', '医生应给患者讲解在已有心血管危险因素存在时，性活动对心脏有潜在的危险', '在性活动开始时如出现心绞痛、头晕、恶心等症状，须终止性活动，并与医生讨论这些情况', '对眼睛的影响：医生应告知患者，若出现单眼或双眼突然视力丧失，应立即停止服用所有5 型磷酸二酯酶PDE5抑制剂，包括枸橼酸西地那非片，并向医生咨询', '该情况可能是非动脉性前部缺血性视神经病NAION的表现，NAION 是可引起视力下降包括永久性丧失的一种疾病，在所有PDE5 抑制剂的上市后应用中均有与用药时间相关的NAION 的罕见报告', '一项观察性病例交叉研究通过与之前一段时间内使用PDE5 抑制剂相比，评估了在刚刚发生NAION 前5 个半衰期之内使用PDE5 抑制剂类药物时发生NAION 的风险', '结果显示，NAION 的风险增加了大约2 倍，风险估计值为2.1595 CI 1.06，4.34', '一项类似研究报告了一致结果，风险估计值为2.2795 CI 0.99，5.20', 'NAION 的其他风险因素例如视神经盘拥挤可能参与这些研究中发生的NAION', '上市后的罕见报告以及观察性研究中PDE5 抑制剂使用与NAION的相关性均未证实PDE5 抑制剂使用与NAION 之间存在因果关系见不良反应上市后经验部分', '已发表的文献资料显示，在普通人群中，NAION 的年发病率为每10 万男性50 岁中2.511.8 个病例', '若发生突然视力丧失，应建议患者停止服用西地那非并且立刻咨询医师', '对于伴有潜在NAION 风险因素的患者，医生应考虑其是否会因为使用PDE5 抑制剂而受到不良影响', '已经发生过NAION 的个体，NAION 再发的风险增高', '医生应告知曾发生过单眼NAION的患者：不论血管扩张药物如PDE5 抑制剂是否会对他们有不良影响，他们再次发生NAION 的风险都会增加', '在这些患者中，仅在预期获益超过风险的情况下，才应谨慎使用PDE5 抑制剂包括西地那非', '视神经盘拥挤患者的NAION 风险也被认为较一般人群更高，但是，证据尚不足以支持应根据这种少见疾病筛选PDE5 抑制剂包括本品的潜在使用者', '对于色素性视网膜炎患者其中少部分患者患有视黄醛磷酸二酯酶遗传病，目前尚无本品的安全性或有效性的对照临床数据', '不能确定这些事件与应用PDE5抑制剂直接相关或与其他因素有关', '医生应告知曾发生过单眼NAION 的患者：不论血管扩张药物如PDE5 抑制剂是否会对他们有不良影响见不良反应上市后经验特殊感觉部分，他们再次发生NAION 的风险都会增加', '听力丧失：医生应告知患者，如果突然发生听力减退或丧失，应停止服用PDE5 抑制剂包括本品，并尽快就医', '此类事件可伴随耳鸣和头晕，据报导与服用PDE5 抑制剂包括枸橼酸西地那非片有时间相关性', '但不能确定此类事件是否与使用PDE5 抑制剂或其它因素有直接关系见不良反应上市前经验部分及上市后经验部分', '医生应警告患者：国外批准枸橼酸西地那非片上市后，有少量勃起时间延长 超过4 小时和异常勃起痛性勃起超过6 小时的报告', '如持续勃起超过4小时，患者应立即就诊', '医生应告知患者，本品不应与其它PDE5抑制剂合用', '本品与其它PDE5抑制剂合用的安全性和有效性尚未经研究', '有关性传播疾病的患者咨询建议：西地那非对性传播疾病无保护作用', '应酌情告知患者预防性传播疾病包括人类免疫缺陷病毒，HIV的措施', '对驾驶和使用机器能力的影响 由于在西地那非临床研究中曾报告了头晕和视觉改变，故患者应在驾驶和操作机器前了解其可能对西地那非产生的反应', '目前尚未研究西地那非对驾驶和使用机器能力的影响']

疾病信息:
- 名称: 肺动脉高压
- 标准名称: None
- ICD编码: None

4. 规则分析结果:
{
  "is_offlabel": true,
  "confidence": 0.0,
  "reasoning": [],
  "evidence": []
}

5. 生成的提示:
请分析以下用药情况是否属于超适应症用药。

输入信息：
1. 药品信息：
   - 名称：枸橼酸西地那非片
   - 标准适应症：["西地那非适用于治疗勃起功能障碍"]
   - 药理毒理：无相关信息
   - 禁忌：["硝酸酯类：由于已知的枸橼酸西地那非片对一氧化氮cGMP途径的作用见药理毒理，西地那非可增强硝酸酯的降压作用", "故服用一氧化氮供体例如任何形式的有机硝酸酯类或有机亚硝酸酯类的患者，无论是规律服用或间断服用，均为禁忌症", "禁止PDE5 抑制剂包括西地那非与鸟苷酸环化酶激动剂例如利奥西呱合用，因为这样可能会引起症状性低血压", "患者服用西地那非后，何时可以安全地服用硝酸酯类药物如需要目前尚不清楚", "根据健康志愿者药代动力学资料，单剂口服100mg，24 小时后血浆西地那非浓度约为2ngml峰值血药浓度约为440 ngml 见药代动力学", "以下患者服药24 小时后血浆西地那非浓度较健康志愿者高38 倍：年龄65 岁以上、肝损害如肝硬化、严重肾损害肌酐清除率30mlmin 以下、同时服用细胞色素P4503A4 的强抑制剂如红霉素等", "尽管服药24小时后的西地那非血药浓度远远低于峰浓度，但尚不了解此时是否可以安全地服用硝酸酯类药物", "已知对本品中任何成份过敏的患者禁用", "警告 心血管：性活动对已有心血管疾病患者的心脏有潜在危险", "因此，其心血管状态不宜进行性活动的患者一般不应使用包括西地那非在内的治疗勃起功能障碍的药物", "由于西地那非使体循环血管舒张，健康志愿者的仰卧位血压发生短暂的降低平均最大降幅8.45.5mmHg见药理毒理", "通常在大多数患者，此种影响的结果可以不计，但医师开处方前仍要仔细斟酌这种血管舒张效应是否会给伴有心血管疾病的患者带来不良的后果，尤其是在性活动时", "有下列潜在疾病的患者对包括西地那非在内的血管扩张剂的作用可能尤为敏感包括左心室流出道梗阻如主动脉狭窄，特发性肥厚性主动脉瓣下狭窄和伴有血压自主控制严重损害的疾病", "此类患者应谨慎用药", "目前，没有以下人群应用西地那非的安全性和有效性的临床对照试验资料", "对此类患者，处方须谨慎： 最近6个月内曾有心肌梗死、休克或危及生命的心律失常的患者", "静息状态低血压血压9050mmHg 以下或高血压血压170110mmHg 以上的患者", "有心力衰竭或冠心病不稳定性心绞痛的患者", "色素视网膜炎的患者少数此病患者有视网膜磷酸二酯酶的遗传性异常", "镰状细胞性贫血或相关贫血患者", "勃起时间延长和阴茎异常勃起：国外批准枸橼酸西地那非片上市后，有少量勃起时间延长超过4小时和异常勃起痛性勃起超过6小时的报告", "如持续勃起超过4小时，患者应立即就诊", "如异常勃起未得到即刻处理，阴茎组织将可能受到损害并可能导致永久性的勃起功能丧失", "以下疾病患者慎用西地那非：阴茎解剖畸形如阴茎偏曲、海绵体纤维化、Peyronie 氏病，易引起阴茎异常勃起的疾病如镰状细胞性贫血、多发性骨髓瘤、白血病", "但是，目前尚无本品在镰状细胞贫血或相关贫血患者中的安全性或有效性的对照临床数据", "与利托那韦合并用药导致的不良反应：同时服用蛋白酶抑制剂利托那韦 会显著增加西地那非的血药浓度AUC增加11 倍", "服用利托那韦的患者需慎用西地那非", "有关高血药浓度西地那非对受试者影响的资料很有限，仅知道视觉异常在高剂量时更常见", "某些服用高剂量西地那非200800mg的健康受试者报告了血压下降、晕厥和勃起时间延长", "为减少服用利托那韦的患者发生不良事件的可能性，建议减小其西地那非的用药剂量"]
   - 注意事项：["一般事项 诊断勃起功能障碍的同时应明确其潜在的病因，进行全面的医学检查后确定适当的治疗方案", "在给患者应用西地那非之前，须注意以下一些重要问题： 与α受体阻滞剂或抗高血压药物合并用药时的低血压 α受体阻滞剂：PDE55型磷酸二酯酶抑制剂与α受体阻滞剂合用时需谨慎", "PDE5抑制剂包括本品与α受体阻滞剂同为血管扩张剂，都具有降低血压的作用", "当合用血管扩张剂时，可以预期对血压的作用可能累加", "在部分患者中，这两类药物合用可显著降低血压，导致低血压症状如头晕、头昏、昏厥见药物相互作用", "还应注意以下情况： 患者接受西地那非治疗前，应已经达到α受体阻滞剂治疗稳定状态", "单独服用α受体阻滞剂治疗血流动力学不稳定的患者，合用PDE5抑制剂后发生低血压症状的风险增加", "接受α受体阻滞剂治疗已达稳定状态的患者，PDE5抑制剂应从最低剂量开始服用", "对于已经服用理想剂量PDE5抑制剂的患者，接受α受体阻滞剂治疗应从最低剂量开始", "同时服用PDE5抑制剂，随着α受体阻滞剂剂量的逐步增加，可能进一步降低血压", "联合应用PDE5抑制剂与α受体阻滞剂的安全性可能受其它因素的影响，包括血管内容量不足和其它抗高血压药物", "降压药物：西地那非使体循环血管扩张，可能增强其它抗高血压药物的降压作用", "在主要的临床试验中包括了同时服用多种抗高血压药物的患者", "另一个独立的药物相互作用研究显示，服用5mg或10mg氨氯地平的高血压患者加用枸橼酸西地那非片100mg量时，收缩压和舒张压平均进一步降低8mmHg和7mmHg见药物相互作用", "在三项药物相互作用的研究中，接受多沙唑嗪治疗达稳定状态的良性前列腺增生BPH患者同时服用α受体阻滞剂多沙唑嗪4mg和8 mg和西地那非25mg、50mg 或100mg，在这些研究人群中，观察到仰卧位血压平均各进一步降低77mmHg、95mmHg 和84mmHg，而立位血压平均各进一步降低66mmHg、114mmHg 和45mmHg", "如同时服用更大剂量西地那非和多沙唑嗪4mg，在服药后14 小时内有个别患者出现体位性低血压症状的报告，包括头晕、头晕目眩，而无晕厥", "给予α 受体阻滞剂治疗的患者同时服用西地那非可能会在一些患者中引起低血压症状", "因此，西地那非剂量如超过25mg，不应在服用α受体阻滞剂4 小时之内服用", "安全性数据库分析显示，西地那非与或不与降压药物同服，患者的副作用无差异", "上市后经验，有与西地那非相关的勃起时间延长和异常勃起的报告", "如持续勃起超过4 小时，患者应立即就诊", "如异常勃起未得到即刻处理，阴茎组织将可能受到损害并可能导致永久性的勃起功能丧失", "与其他PDE5 抑制剂或其他勃起功能障碍治疗合并用药：其他PDE5 抑制剂，或含有西地那非的其他肺动脉高压PAH治疗药物Revatio，或者其他勃起功能障碍的治疗方法与本品合用的安全性和有效性尚未经研究", "此类联合用药可能会进一步降低血压", "故不推荐联合使用", "对出血的影响：在曾服用枸橼酸西地那非片的患者中，曾有过上市后出血事件的报道", "本品与这些事件之间的因果关系尚未确立", "无论单独使用或与阿司匹林合用，枸橼酸西地那非片对人出血时间没有影响", "然而，体外实验中，枸橼酸西地那非片增强硝普钠一种一氧化氮供体的抗人类血小板凝聚作用", "此外，在麻醉下的家兔，肝素与西地那非合用对出血时间的延长有叠加作用，但未进行过类似的人体研究", "目前未知枸橼酸西地那非片在出血性疾病患者和活动性消化道溃疡患者中的安全性", "患者须知 医生应给患者讲解禁止西地那非与硝酸酯同时服用无论后者是规律还是间断用药", "医生应告知患者，西地那非有增强α受体阻滞剂和其它抗高血压药物降压作用的潜在可能", "同时服用西地那非和α受体阻滞剂可能会引起一些患者的低血压症状", "需要合并使用西地那非与α受体阻滞剂时，西地那非治疗前，患者应已经达到α受体阻滞剂治疗稳定状态，并且西地那非应该从最低剂量开始服用", "医生应给患者讲解在已有心血管危险因素存在时，性活动对心脏有潜在的危险", "在性活动开始时如出现心绞痛、头晕、恶心等症状，须终止性活动，并与医生讨论这些情况", "对眼睛的影响：医生应告知患者，若出现单眼或双眼突然视力丧失，应立即停止服用所有5 型磷酸二酯酶PDE5抑制剂，包括枸橼酸西地那非片，并向医生咨询", "该情况可能是非动脉性前部缺血性视神经病NAION的表现，NAION 是可引起视力下降包括永久性丧失的一种疾病，在所有PDE5 抑制剂的上市后应用中均有与用药时间相关的NAION 的罕见报告", "一项观察性病例交叉研究通过与之前一段时间内使用PDE5 抑制剂相比，评估了在刚刚发生NAION 前5 个半衰期之内使用PDE5 抑制剂类药物时发生NAION 的风险", "结果显示，NAION 的风险增加了大约2 倍，风险估计值为2.1595 CI 1.06，4.34", "一项类似研究报告了一致结果，风险估计值为2.2795 CI 0.99，5.20", "NAION 的其他风险因素例如视神经盘拥挤可能参与这些研究中发生的NAION", "上市后的罕见报告以及观察性研究中PDE5 抑制剂使用与NAION的相关性均未证实PDE5 抑制剂使用与NAION 之间存在因果关系见不良反应上市后经验部分", "已发表的文献资料显示，在普通人群中，NAION 的年发病率为每10 万男性50 岁中2.511.8 个病例", "若发生突然视力丧失，应建议患者停止服用西地那非并且立刻咨询医师", "对于伴有潜在NAION 风险因素的患者，医生应考虑其是否会因为使用PDE5 抑制剂而受到不良影响", "已经发生过NAION 的个体，NAION 再发的风险增高", "医生应告知曾发生过单眼NAION的患者：不论血管扩张药物如PDE5 抑制剂是否会对他们有不良影响，他们再次发生NAION 的风险都会增加", "在这些患者中，仅在预期获益超过风险的情况下，才应谨慎使用PDE5 抑制剂包括西地那非", "视神经盘拥挤患者的NAION 风险也被认为较一般人群更高，但是，证据尚不足以支持应根据这种少见疾病筛选PDE5 抑制剂包括本品的潜在使用者", "对于色素性视网膜炎患者其中少部分患者患有视黄醛磷酸二酯酶遗传病，目前尚无本品的安全性或有效性的对照临床数据", "不能确定这些事件与应用PDE5抑制剂直接相关或与其他因素有关", "医生应告知曾发生过单眼NAION 的患者：不论血管扩张药物如PDE5 抑制剂是否会对他们有不良影响见不良反应上市后经验特殊感觉部分，他们再次发生NAION 的风险都会增加", "听力丧失：医生应告知患者，如果突然发生听力减退或丧失，应停止服用PDE5 抑制剂包括本品，并尽快就医", "此类事件可伴随耳鸣和头晕，据报导与服用PDE5 抑制剂包括枸橼酸西地那非片有时间相关性", "但不能确定此类事件是否与使用PDE5 抑制剂或其它因素有直接关系见不良反应上市前经验部分及上市后经验部分", "医生应警告患者：国外批准枸橼酸西地那非片上市后，有少量勃起时间延长 超过4 小时和异常勃起痛性勃起超过6 小时的报告", "如持续勃起超过4小时，患者应立即就诊", "医生应告知患者，本品不应与其它PDE5抑制剂合用", "本品与其它PDE5抑制剂合用的安全性和有效性尚未经研究", "有关性传播疾病的患者咨询建议：西地那非对性传播疾病无保护作用", "应酌情告知患者预防性传播疾病包括人类免疫缺陷病毒，HIV的措施", "对驾驶和使用机器能力的影响 由于在西地那非临床研究中曾报告了头晕和视觉改变，故患者应在驾驶和操作机器前了解其可能对西地那非产生的反应", "目前尚未研究西地那非对驾驶和使用机器能力的影响"]

2. 患者情况：
   - 诊断：肺动脉高压
   - 详细描述：患者诊断为继发性肺动脉高压，拟使用西地那非治疗。患者有明显的呼吸困难和活动耐量下降症状。

3. 规则分析结果：
   {"is_offlabel": true, "confidence": 0.0, "reasoning": [], "evidence": []}

4. 临床指南：
   （数据不可用）
   []

5. 专家共识：
   （数据不可用）
   []

6. 研究证据：
   （数据不可用）
   []

注意事项：
1. 对于标记为"（数据不可用）"的信息，请在分析中明确指出缺少该类数据，并解释这可能如何影响您的判断。
2. 在证据等级评估时，如果某类证据缺失，应相应降低整体评估的可信度。
3. 即使缺少部分数据，也请尽可能基于现有信息给出合理的分析和建议。
4. 在结果中，请明确指出哪些结论是基于完整数据得出的，哪些是在数据缺失情况下的推测。

请按照以下格式返回分析结果（注意：必须是合法的JSON格式，不要添加任何注释或说明）：

{
  "is_offlabel": false,
  "confidence": 0.85,
  "analysis": {
    "indication_match": {
      "score": 0.9,
      "matching_indication": "标准适应症名称",
      "reasoning": "匹配度分析原因"
    },
    "mechanism_similarity": {
      "score": 0.8,
      "reasoning": "机制相似性分析说明"
    },
    "evidence_support": {
      "level": "B",
      "description": "支持证据说明"
    }
  },
  "recommendation": {
    "decision": "建议使用",
    "explanation": "建议说明",
    "risk_assessment": "风险评估说明"
  },
  "data_limitations": {
    "missing_data": ["临床指南", "专家共识"],
    "impact_on_analysis": "数据缺失对分析的影响说明"
  }
}

6. 原始LLM响应:
{"is_offlabel": true, "confidence": 0.0, "reasoning": ["患者诊断为肺动脉高压，而枸橼酸西地那非片的标准适应症为治疗勃起功能障碍。"], "evidence": ["枸橼酸西地那非片的标准适应症为治疗勃起功能障碍，而患者诊断为肺动脉高压。"]}


7. 清理后的LLM响应:
{"is_offlabel": true, "confidence": 0.0, "reasoning": ["患者诊断为肺动脉高压，而枸橼酸西地那非片的标准适应症为治疗勃起功能障碍。"], "evidence": ["枸橼酸西地那非片的标准适应症为治疗勃起功能障碍，而患者诊断为肺动脉高压。"]}

8. 最终分析结果:
{
  "is_offlabel": true,
  "confidence": 0.49000000000000005,
  "analysis": {
    "indication_match": {
      "score": 0.18000000000000002,
      "matching_indication": "治疗勃起功能障碍",
      "reasoning": "患者诊断为肺动脉高压，而西地那非的标准适应症是治疗勃起功能障碍，两者在适应症上不匹配。"
    },
    "mechanism_similarity": {
      "score": 0.8,
      "reasoning": "西地那非通过抑制PDE5，增加cGMP水平，导致血管舒张。虽然其机制与治疗肺动脉高压相关，但标准适应症不包括肺动脉高压。"
    },
    "evidence_support": {
      "level": "B",
      "description": "虽然没有直接的临床指南或专家共识支持，但药理机制显示可能有效。"
    }
  },
  "recommendation": {
    "decision": "谨慎使用",
    "explanation": "虽然属于超适应症用药，但有一定的证据支持其合理性。建议在充分评估风险收益后决定是否使用。",
    "risk_assessment": "未发现明显风险，但仍需要注意监测不良反应。"
  },
  "evidence_synthesis": {
    "matching_indication": "治疗勃起功能障碍",
    "indication_match_reasoning": [
      "患者诊断为肺动脉高压，而西地那非的标准适应症是治疗勃起功能障碍，两者在适应症上不匹配。"
    ],
    "mechanism_reasoning": [
      "西地那非通过抑制PDE5，增加cGMP水平，导致血管舒张。虽然其机制与治疗肺动脉高压相关，但标准适应症不包括肺动脉高压。"
    ],
    "evidence_level": "B",
    "evidence_description": [
      "虽然没有直接的临床指南或专家共识支持，但药理机制显示可能有效。"
    ],
    "sources": []
  },
  "metadata": {
    "analysis_time": "2025-02-21T12:13:26.669966",
    "rule_confidence": 0.0,
    "llm_confidence": 0.85,
    "evidence_sources": []
  }
}

PASSED

========================================= 2 passed in 29.16s =========================================