# æµ‹è¯•æ–‡æ¡£

Med-GraphRAGé¡¹ç›®çš„æµ‹è¯•å¥—ä»¶ï¼ŒåŒ…å«å¿«ç…§æµ‹è¯•å’Œç«¯åˆ°ç«¯æµ‹è¯•ã€‚

## ğŸ“‹ æµ‹è¯•æ–‡ä»¶

### 1. test_pipeline_snapshot.py - Pipelineå¿«ç…§æµ‹è¯•
**ç›®çš„**: éªŒè¯ç¼“å­˜æ•°æ®æ–‡ä»¶çš„å®Œæ•´æ€§  
**ä¾èµ–**: data/ç›®å½•ä¸‹çš„æ–‡ä»¶  
**è¿è¡Œ**: `PYTHONPATH=. pytest tests/test_pipeline_snapshot.py -v`

**æµ‹è¯•å†…å®¹**:
- æ£€æŸ¥processed_drugs.jsonæ–‡ä»¶
- æ£€æŸ¥ç–¾ç—…æå–æ‰¹æ¬¡æ–‡ä»¶
- æ£€æŸ¥æå–çŠ¶æ€æ–‡ä»¶
- éªŒè¯æ•°æ®ç»“æ„

### 2. test_pipeline_e2e.py - Pipelineç«¯åˆ°ç«¯æµ‹è¯• â­
**ç›®çš„**: ç›´æ¥æŸ¥è¯¢æ•°æ®åº“å’Œè°ƒç”¨æ¨¡å—ï¼ŒéªŒè¯å®Œæ•´æµç¨‹  
**ä¾èµ–**: ElasticsearchæœåŠ¡  
**è¿è¡Œ**: `PYTHONPATH=. pytest tests/test_pipeline_e2e.py -v -s`

#### æµ‹è¯•è¯¦è§£

##### TestDrugPipeline - è¯å“æµç¨‹æµ‹è¯•

**test_query_drugs_from_elasticsearch** (æµ‹è¯•1)
```python
ç›®çš„: éªŒè¯è¯å“æ•°æ®å·²æ­£ç¡®å¯¼å…¥ES
æ“ä½œ:
  1. æŸ¥è¯¢drugsç´¢å¼•æ€»æ•°
  2. æŸ¥è¯¢æœ‰é€‚åº”ç—‡çš„è¯å“æ•°
  3. æœç´¢"é˜¿å¸åŒ¹æ—"å¹¶æ˜¾ç¤ºç»“æœ
  
ç»“æœ:
  âœ… è¯å“æ€»æ•°: 86,345ä¸ª
  âœ… æœ‰é€‚åº”ç—‡: 85,923ä¸ª
  âœ… æœç´¢åŠŸèƒ½: æ‰¾åˆ°4,913ä¸ªé˜¿å¸åŒ¹æ—ç›¸å…³è¯å“
  
éªŒè¯:
  - è¯å“æ•°é‡>80,000
  - æœ‰é€‚åº”ç—‡è¯å“>80,000
  - æœç´¢ç»“æœåŒ…å«å®Œæ•´ä¿¡æ¯
```

**test_drug_data_structure** (æµ‹è¯•2)
```python
ç›®çš„: éªŒè¯è¯å“æ•°æ®ç»“æ„å®Œæ•´æ€§
æ“ä½œ:
  1. éšæœºè·å–ä¸€ä¸ªæœ‰é€‚åº”ç—‡å’Œæˆåˆ†çš„è¯å“
  2. æ£€æŸ¥æ‰€æœ‰å¿…éœ€å­—æ®µ
  
ç»“æœ:
  âœ… ç¤ºä¾‹: è¡¥è‚¾ä¸¸
  âœ… å­—æ®µå®Œæ•´: id, name, indications, create_timeç­‰15ä¸ªå­—æ®µ
  
éªŒè¯:
  - å¿…éœ€å­—æ®µéƒ½å­˜åœ¨
  - æ•°æ®ç±»å‹æ­£ç¡®
  - åµŒå¥—ç»“æ„æ­£ç¡®
```

##### TestDiseasePipeline - ç–¾ç—…æµç¨‹æµ‹è¯•

**test_query_diseases_from_elasticsearch** (æµ‹è¯•3)
```python
ç›®çš„: éªŒè¯ç–¾ç—…æ•°æ®å·²æ­£ç¡®å¯¼å…¥ES
æ“ä½œ:
  1. æŸ¥è¯¢diseasesç´¢å¼•æ€»æ•°
  2. æœç´¢"é«˜è¡€å‹"ç–¾ç—…
  3. æŸ¥è¯¢æœ€å¸¸è§çš„Top5ç–¾ç—…
  
ç»“æœ:
  âœ… ç–¾ç—…æ€»æ•°: 25,254ä¸ª
  âœ… é«˜è¡€å‹ç¤ºä¾‹:
     - æåŠæ¬¡æ•°: 1,497æ¬¡
     - å…³è”è¯å“: 10ä¸ªï¼ˆæ˜¾ç¤ºå‰3ä¸ªï¼‰
  âœ… Top5ç–¾ç—…:
     1. çƒ­æ¯’è¯: 3,892æ¬¡
     2. å’³å—½: 3,721æ¬¡
     3. è´¥è¡€ç—‡: 3,700æ¬¡
     4. è·Œæ‰“æŸä¼¤: 2,917æ¬¡
     5. çš®è‚¤è½¯ç»„ç»‡æ„ŸæŸ“: 2,913æ¬¡
  
éªŒè¯:
  - ç–¾ç—…æ•°é‡>5,000
  - æ¯ä¸ªç–¾ç—…æœ‰æ¥æºè¯å“å…³è”
  - æåŠæ¬¡æ•°ç»Ÿè®¡æ­£ç¡®
```

**test_disease_drug_relationship** (æµ‹è¯•4)
```python
ç›®çš„: éªŒè¯è¯å“-ç–¾ç—…åŒå‘å…³è”
æ“ä½œ:
  1. ä»diseasesç´¢å¼•è·å–ä¸€ä¸ªç–¾ç—…
  2. æå–å…³è”çš„è¯å“ID
  3. åœ¨drugsç´¢å¼•ä¸­æŸ¥è¯¢è¯¥è¯å“
  4. éªŒè¯è¯å“æœ‰é€‚åº”ç—‡
  
ç»“æœ:
  âœ… æµ‹è¯•ç–¾ç—…: ä¸‹å‘¼å¸é“æ„ŸæŸ“
  âœ… å…³è”è¯å“: 10ä¸ª
  âœ… åå‘éªŒè¯: èˆ’ä»–è¥¿æ—å¹²æ··æ‚¬å‰‚å­˜åœ¨
  âœ… è¯å“é€‚åº”ç—‡: 5æ¡
  
éªŒè¯:
  - ç–¾ç—…è®°å½•çš„drug_idåœ¨drugsç´¢å¼•ä¸­å­˜åœ¨
  - è¯å“åŒ…å«é€‚åº”ç—‡ä¿¡æ¯
  - åŒå‘å…³è”å®Œæ•´
```

##### TestPipelineIntegration - é›†æˆæµ‹è¯•

**test_disease_indexer_module** (æµ‹è¯•5)
```python
ç›®çš„: éªŒè¯disease_indexeræ¨¡å—å¯æ­£å¸¸è°ƒç”¨
æ“ä½œ:
  1. å¯¼å…¥DiseaseIndexerç±»
  2. åˆå§‹åŒ–å®ä¾‹
  3. æ£€æŸ¥ESè¿æ¥
  4. æŸ¥çœ‹ç´¢å¼•mapping
  
ç»“æœ:
  âœ… æ¨¡å—å¯¼å…¥æˆåŠŸ
  âœ… ESè¿æ¥æ­£å¸¸
  âœ… diseasesç´¢å¼•å­˜åœ¨
  âœ… ç–¾ç—…æ•°é‡: 25,254ä¸ª
  âœ… mappingå­—æ®µ: 12ä¸ª
  
éªŒè¯:
  - æ¨¡å—å¯å¯¼å…¥
  - ç±»å¯å®ä¾‹åŒ–
  - ESæ“ä½œæ­£å¸¸
```

---

### 3. test_entity_recognition.py - å®ä½“è¯†åˆ«æµ‹è¯•
**ç›®çš„**: æµ‹è¯•æ¨ç†æ¨¡å—çš„å®ä½“è¯†åˆ«åŠŸèƒ½  
**ä¾èµ–**: Elasticsearch, LLM API  
**è¿è¡Œ**: `PYTHONPATH=. pytest tests/test_entity_recognition.py`

### 4. test_indication_analysis.py - é€‚åº”ç—‡åˆ†ææµ‹è¯•
**ç›®çš„**: æµ‹è¯•æ¨ç†æ¨¡å—çš„åˆ†æåŠŸèƒ½  
**ä¾èµ–**: Elasticsearch, LLM API  
**è¿è¡Œ**: `PYTHONPATH=. pytest tests/test_indication_analysis.py`

## ğŸ¯ æµ‹è¯•ç­–ç•¥

### Snapshotæµ‹è¯• (test_pipeline_snapshot.py)
- **å¿«é€Ÿ**: åªè¯»å–æ–‡ä»¶ï¼Œä¸ä¾èµ–æœåŠ¡
- **ç”¨é€”**: éªŒè¯æ•°æ®æ–‡ä»¶å®Œæ•´æ€§
- **åœºæ™¯**: å¼€å‘æ—¶å¿«é€Ÿæ£€æŸ¥

### E2Eæµ‹è¯• (test_pipeline_e2e.py) â­
- **å…¨é¢**: ç›´æ¥æŸ¥è¯¢ESï¼Œè°ƒç”¨å®é™…æ¨¡å—
- **ç”¨é€”**: éªŒè¯å®Œæ•´æ•°æ®æµ
- **åœºæ™¯**: éƒ¨ç½²å‰ã€é‡æ„åéªŒè¯

### å•å…ƒæµ‹è¯• (test_entity_*.py)
- **ç²¾ç¡®**: æµ‹è¯•å•ä¸ªåŠŸèƒ½æ¨¡å—
- **ç”¨é€”**: éªŒè¯æ¨ç†é€»è¾‘
- **åœºæ™¯**: åŠŸèƒ½å¼€å‘å’Œè°ƒè¯•

## ğŸ“Š æµ‹è¯•è¦†ç›–

```
Pipelineæµç¨‹:
  PostgreSQL â†’ [drug_etl] â†’ ES(drugs)        âœ… æµ‹è¯•1,2
  ES(drugs) â†’ [disease_extraction] â†’ æ‰¹æ¬¡    âœ… Snapshotæµ‹è¯•
  æ‰¹æ¬¡ â†’ [disease_indexer] â†’ ES(diseases)    âœ… æµ‹è¯•3,4,5

Inferenceæµç¨‹:
  è¾“å…¥ â†’ [entity_matcher] â†’ å®ä½“              âœ… test_entity_recognition
  å®ä½“ â†’ [engine] â†’ åˆ†æç»“æœ                  âœ… test_indication_analysis
```

## ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
# å¿«é€Ÿæµ‹è¯•ï¼ˆsnapshotï¼‰
PYTHONPATH=. pytest tests/test_pipeline_snapshot.py -v

# å®Œæ•´æµ‹è¯•ï¼ˆe2eï¼‰
PYTHONPATH=. pytest tests/test_pipeline_e2e.py -v -s

# æ¨ç†æµ‹è¯•
PYTHONPATH=. pytest tests/test_entity_recognition.py
PYTHONPATH=. pytest tests/test_indication_analysis.py

# è¿è¡Œæ‰€æœ‰
PYTHONPATH=. pytest tests/ -v
```

## ğŸ“ˆ æµ‹è¯•ç»“æœè¯´æ˜

### æˆåŠŸæŒ‡æ ‡
- æ‰€æœ‰æµ‹è¯•PASSED
- æ•°æ®é‡ç¬¦åˆé¢„æœŸ
- ESæŸ¥è¯¢æ­£å¸¸è¿”å›
- å…³è”å…³ç³»æ­£ç¡®

### å¸¸è§é—®é¢˜
1. **ModuleNotFoundError**: éœ€è¦ `PYTHONPATH=.`
2. **diseasesç´¢å¼•ä¸å­˜åœ¨**: è¿è¡Œ `python -m app.pipeline.disease_indexer --rebuild`
3. **ESè¿æ¥å¤±è´¥**: æ£€æŸ¥DockeræœåŠ¡ `docker compose ps`

## âœ¨ æµ‹è¯•ä»·å€¼

è¿™äº›æµ‹è¯•ç¡®ä¿ï¼š
1. âœ… æ•°æ®å®Œæ•´æ€§ï¼š86kè¯å“ã€25kç–¾ç—…éƒ½åœ¨ESä¸­
2. âœ… å…³è”æ­£ç¡®ï¼šè¯å“-ç–¾ç—…åŒå‘å¯æŸ¥
3. âœ… åŠŸèƒ½å¯ç”¨ï¼šæœç´¢ã€æŸ¥è¯¢ã€ç»Ÿè®¡éƒ½æ­£å¸¸
4. âœ… æ¨¡å—å¥åº·ï¼šæ‰€æœ‰ç±»å¯å¯¼å…¥å’Œå®ä¾‹åŒ–

é€šè¿‡æµ‹è¯•åï¼Œå¯ä»¥ç¡®ä¿¡æ•´ä¸ªæ•°æ®å»ºåº“æµç¨‹æ˜¯å®Œæ•´ã€æ­£ç¡®ã€å¯ç”¨çš„ï¼
