# åŒ»ç–—è¶…é€‚åº”ç—‡æ™ºèƒ½åˆ†æç³»ç»Ÿ - è®¾è®¡ä¸å®ç°

## ç³»ç»Ÿæ¶æ„

### æ€»ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è¾“å…¥å±‚ (Input Layer)                    â”‚
â”‚  åŒ»ç–—æ–‡æœ¬ã€æ‚£è€…ä¿¡æ¯ã€å¤„æ–¹ä¿¡æ¯                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ¨ç†å¼•æ“ (InferenceEngine)                  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ å®ä½“è¯†åˆ«æ¨¡å— â”‚â†’â”‚ çŸ¥è¯†å¢å¼ºæ¨¡å— â”‚â†’â”‚ åˆ†æåˆ¤æ–­æ¨¡å—  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                â”‚                 â”‚                â”‚
â”‚         â–¼                â–¼                 â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚           Elasticsearch çŸ¥è¯†å›¾è°±              â”‚          â”‚
â”‚  â”‚  â€¢ è¯å“ç´¢å¼• (67.9k indications_list)        â”‚          â”‚
â”‚  â”‚  â€¢ ç–¾ç—…ç´¢å¼• (108k diseases)                 â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è¾“å‡ºå±‚ (Output Layer)                      â”‚
â”‚  â€¢ is_offlabel: è¶…é€‚åº”ç—‡åˆ¤æ–­                                â”‚
â”‚  â€¢ indication_match: è§„åˆ™åˆ¤æ–­ç»“æœ                           â”‚
â”‚  â€¢ open_evidence: AIè¾…åŠ©åˆ†æ                                â”‚
â”‚  â€¢ recommendation: ç”¨è¯å»ºè®®                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Inference æ¨¡å—è¯¦ç»†è®¾è®¡

### æ¨¡å—ç»„æˆ

```
app/inference/
â”œâ”€â”€ engine.py              # æ¨ç†å¼•æ“ï¼ˆæ€»æ§åˆ¶å™¨ï¼‰
â”œâ”€â”€ entity_matcher.py      # å®ä½“è¯†åˆ«
â”œâ”€â”€ knowledge_retriever.py # çŸ¥è¯†å¢å¼º
â”œâ”€â”€ rule_checker.py        # è§„åˆ™åˆ†æ
â”œâ”€â”€ llm_reasoner.py        # LLMæ¨ç†
â”œâ”€â”€ result_synthesizer.py  # ç»“æœç»¼åˆ
â”œâ”€â”€ result_generator.py    # ç»“æœç”Ÿæˆ
â”œâ”€â”€ models.py              # æ•°æ®æ¨¡å‹
â””â”€â”€ prompt.py              # Promptæ¨¡æ¿
```

### å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¾“å…¥æ•°æ®  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EntityRecognizerâ”‚  [LLM] æå–è¯å“/ç–¾ç—…å
â”‚                 â”‚  [ES]  æŸ¥æ‰¾æ ‡å‡†åŒ–å®ä½“
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ RecognizedEntities
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚KnowledgeEnhancerâ”‚  [ES] è·å–å®Œæ•´è¯å“ä¿¡æ¯
â”‚                 â”‚       â€¢ indications_list âœ¨
â”‚                 â”‚       â€¢ contraindications
â”‚                 â”‚       â€¢ pharmacology
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ EnhancedCase
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RuleAnalyzer  â”‚  ç²¾ç¡®å­—ç¬¦ä¸²åŒ¹é…
â”‚                â”‚  confidence = 1.0/0.9/0.8/0.0
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ rule_result
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LLM Reasoner   â”‚  [LLM] æ·±åº¦åˆ†æ
â”‚                â”‚  â€¢ mechanism_similarity
â”‚                â”‚  â€¢ evidence_support
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ llm_result
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ResultSynthesizerâ”‚  ç»¼åˆåˆ¤æ–­
â”‚                 â”‚  â€¢ is_offlabel (è§„åˆ™)
â”‚                 â”‚  â€¢ open_evidence (AI)
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ synthesis_result
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ResultGenerator â”‚  æ ¼å¼åŒ–è¾“å‡º
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ€ç»ˆç»“æœ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒæŠ€æœ¯å®ç°

### 1. å®ä½“è¯†åˆ«ä¸æ ‡å‡†åŒ–

**EntityRecognizer**ï¼ˆentity_matcher.pyï¼‰

```python
# åŒé‡éªŒè¯æœºåˆ¶
LLMæå– â†’ ESéªŒè¯å¯¹é½ â†’ æ ‡å‡†åŒ–å®ä½“

# ç¤ºä¾‹
è¾“å…¥: "æ°¢åŒ–å¯çš„æ¾"
LLMè¯†åˆ«: "æ°¢åŒ–å¯çš„æ¾"
ESåŒ¹é…: "æ°¢åŒ–å¯çš„æ¾ç‰‡" (ID: caa26d34...)
è¾“å‡º: RecognizedDrug(name="æ°¢åŒ–å¯çš„æ¾", standard_name="æ°¢åŒ–å¯çš„æ¾ç‰‡")
```

**å…³é”®ç‰¹æ€§**ï¼š
- åˆ†å±‚æœç´¢ç­–ç•¥ï¼ˆç²¾ç¡®â†’æ¨¡ç³Šï¼‰
- ç–¾ç—…åŒ¹é…ä¸¥æ ¼åŒ–ï¼ˆé¿å…é”™è¯¯åŒ¹é…ï¼‰
- æ”¯æŒæ— ESåŒ¹é…æ—¶ä½¿ç”¨LLMè¯†åˆ«çš„åŸå§‹åç§°

---

### 2. çŸ¥è¯†å¢å¼º

**KnowledgeEnhancer**ï¼ˆknowledge_retriever.pyï¼‰

```python
# çŸ¥è¯†å¢å¼ºæµç¨‹
Case â†’ get_drug_by_id() â†’ å®Œæ•´è¯å“ä¿¡æ¯
     â†’ get_disease_by_id() â†’ å®Œæ•´ç–¾ç—…ä¿¡æ¯
     â†’ _gather_evidence() â†’ ä¸´åºŠè¯æ®ï¼ˆå¾…å®ç°ï¼‰

# å…³é”®åˆ›æ–°
ä¼˜å…ˆè¯»å– indications_list: ["ç–¾ç—…1", "ç–¾ç—…2", ...]  # ç»“æ„åŒ–åˆ—è¡¨
é™çº§è¯»å– indications: ["é•¿å¥æè¿°..."]              # åŸå§‹æ–‡æœ¬
```

**æ•°æ®æ¥æº**ï¼š
- âœ… Elasticsearchï¼ˆè¯å“ã€ç–¾ç—…ï¼‰
- ğŸš§ ä¸´åºŠæŒ‡å—ï¼ˆTODOï¼‰
- ğŸš§ ä¸“å®¶å…±è¯†ï¼ˆTODOï¼‰
- ğŸš§ ç ”ç©¶æ–‡çŒ®ï¼ˆTODOï¼‰

---

### 3. è§„åˆ™åˆ†æ

**RuleAnalyzer**ï¼ˆrule_checker.pyï¼‰

```python
# åˆ¤æ–­é€»è¾‘ï¼ˆä¸¥æ ¼ç²¾ç¡®åŒ¹é…ï¼‰
def exact_match(drug_info, disease_info):
    if ç–¾ç—…å in indications_list:  # ç²¾ç¡®åŒ¹é…
        return confidence=1.0
    return confidence=0.0

# ç¤ºä¾‹
é€‚åº”ç—‡åˆ—è¡¨: ["å…ˆå¤©æ€§è‚¾ä¸Šè…ºçš®è´¨å¢ç”Ÿç—‡", "è‚¾ä¸Šè…ºçš®è´¨åŠŸèƒ½å‡é€€ç—‡"]
æ‚£è€…ç–¾ç—…: "21-ç¾ŸåŒ–é…¶ç¼ºä¹ç—‡"
åˆ¤æ–­: NOT IN åˆ—è¡¨ â†’ confidence=0.0 â†’ is_offlabel=True âœ…
```

**å…³é”®ç‚¹**ï¼š
- âœ… åªæœ‰å®Œå…¨ç›¸ç­‰æ‰æ˜¯ç²¾ç¡®åŒ¹é…
- âœ… é•¿å¥æ—¶æ‰ä½¿ç”¨å­ä¸²åŒ¹é…ï¼ˆå‘åå…¼å®¹ï¼‰
- âœ… åŒä¹‰è¯/å±‚çº§åŒ¹é…ä¸å½±å“is_offlabel

---

### 4. LLMæ¨ç†

**IndicationAnalyzer**ï¼ˆllm_reasoner.pyï¼‰

```python
# åˆ†æå†…å®¹
1. è§„åˆ™åˆ†æç»“æœreview
2. è¯ç†æœºåˆ¶åˆ†æï¼ˆAIè¾…åŠ©ï¼‰
3. ä¸´åºŠè¯æ®è¯„ä¼°ï¼ˆAIè¾…åŠ©ï¼‰
4. é£é™©è¯„ä¼°

# å…³é”®çº¦æŸ
Promptä¸­æ˜ç¡®è¦æ±‚ï¼š
- é€‚åº”ç—‡åŒ¹é…åªåšå­—ç¬¦ä¸²åŒ¹é…ï¼Œä¸åšåŒ»å­¦æ¨ç†
- mechanism_similarityä»…ä½œå‚è€ƒï¼Œä¸å½±å“is_offlabel
```

---

### 5. ç»“æœç»¼åˆ

**ResultSynthesizer**ï¼ˆresult_synthesizer.pyï¼‰

```python
# åˆ¤æ–­é€»è¾‘ï¼ˆ2025-10-30ä¼˜åŒ–ï¼‰
def _determine_final_offlabel_status():
    if rule_confidence >= 1.0:  # åªæœ‰ç²¾ç¡®åŒ¹é…
        return False  # æ ‡å‡†ç”¨è¯
    return True  # è¶…é€‚åº”ç—‡ï¼ˆä¸¥æ ¼å®šä¹‰ï¼‰

# è¾“å‡ºç»“æ„
{
  "is_offlabel": True,            # è§„åˆ™åˆ¤æ–­
  "analysis_details": {
    "indication_match": {...},    # è§„åˆ™ä¾æ®
    "open_evidence": {            # AIè¾…åŠ©
      "mechanism_similarity": {...},
      "evidence_support": {...}
    },
    "recommendation": {...}
  }
}
```

---

## æ•°æ®å±‚è®¾è®¡

### Elasticsearchç´¢å¼•

#### 1. drugsç´¢å¼•
```json
{
  "id": "caa26d34...",
  "name": "æ°¢åŒ–å¯çš„æ¾ç‰‡",
  "indications_list": [        // âœ¨ å…³é”®å­—æ®µ
    "å…ˆå¤©æ€§è‚¾ä¸Šè…ºçš®è´¨å¢ç”Ÿç—‡",
    "è‚¾ä¸Šè…ºçš®è´¨åŠŸèƒ½å‡é€€ç—‡"
  ],
  "contraindications": [...],
  "details": {...}
}
```

**ç»Ÿè®¡**ï¼š
- æ€»è¯å“æ•°: 1,953,754
- æœ‰indications_list: 67,939 (3.5%)
- indications_listæ•°æ®è´¨é‡: ä¼˜ç§€

#### 2. diseasesç´¢å¼•
```json
{
  "id": "disease_823",
  "name": "è‚ºåŠ¨è„‰é«˜å‹",
  "category": "å¿ƒè¡€ç®¡ç³»ç»Ÿç–¾ç—…",
  "icd_code": "I27.0"
}
```

**ç»Ÿè®¡**ï¼š
- æ€»ç–¾ç—…æ•°: 108,660

---

## è¾“å‡ºæ ¼å¼

### æœ€ç»ˆè¾“å‡ºç»“æ„

```json
{
  "case_id": "xxx",
  "analysis_time": "2025-10-30T10:25:43",
  
  "drug_info": {
    "id": "caa26d34...",
    "name": "æ°¢åŒ–å¯çš„æ¾",
    "standard_name": "æ°¢åŒ–å¯çš„æ¾ç‰‡"
  },
  
  "disease_info": {
    "id": null,
    "name": "21-ç¾ŸåŒ–é…¶ç¼ºä¹ç—‡",
    "standard_name": null
  },
  
  "is_offlabel": true,  // ä¸¥æ ¼è§„åˆ™åˆ¤æ–­
  
  "analysis_details": {
    "indication_match": {  // è§„åˆ™åˆ¤æ–­
      "score": 0.0,
      "matching_indication": "æ— ",
      "reasoning": "æœªåœ¨é€‚åº”ç—‡åˆ—è¡¨ä¸­ç²¾ç¡®åŒ¹é…"
    },
    
    "open_evidence": {  // AIè¾…åŠ©
      "mechanism_similarity": {
        "score": 0.9,
        "reasoning": "21-ç¾ŸåŒ–é…¶ç¼ºä¹ç—‡æ˜¯å…ˆå¤©æ€§è‚¾ä¸Šè…ºçš®è´¨å¢ç”Ÿç—‡çš„äºšå‹ï¼Œæœºåˆ¶ç›¸å…³"
      },
      "evidence_support": {
        "level": "D",
        "clinical_guidelines": [],
        "expert_consensus": [],
        "research_papers": [],
        "description": "åŸºäºæœºåˆ¶ç›¸ä¼¼æ€§æ¨æµ‹"
      }
    },
    
    "recommendation": {
      "decision": "è°¨æ…ä½¿ç”¨",
      "explanation": "è™½å±è¶…é€‚åº”ç—‡ï¼Œä½†æœºåˆ¶åˆç†",
      "risk_assessment": "éœ€ç›‘æµ‹ä¸è‰¯ååº”"
    }
  },
  
  "metadata": {
    "analysis_time": "...",
    "rule_confidence": 0.0,
    "llm_confidence": 0.3,
    "evidence_sources": []
  }
}
```

## å…³é”®è®¾è®¡å†³ç­–

### 1. åˆ¤æ–­é€»è¾‘ä¸¥æ ¼åŒ–

```
è¶…é€‚åº”ç—‡å®šä¹‰ï¼šè¯å“ç”¨äºè¯´æ˜ä¹¦æœªæ‰¹å‡†çš„é€‚åº”ç—‡
åˆ¤æ–­æ ‡å‡†ï¼šä¸¥æ ¼çš„å­—ç¬¦ä¸²ç²¾ç¡®åŒ¹é…
ç³»ç»Ÿå®šä½ï¼š
  - è§„åˆ™åˆ¤æ–­ï¼šç¡®å®šæ€§ã€ä¸¥æ ¼æ€§
  - AIè¾…åŠ©ï¼šå‚è€ƒæ€§ã€çµæ´»æ€§
```

### 2. æ•°æ®ç»“æ„ä¼˜åŒ–

```
indications (åŸå§‹)          indications_list (ä¼˜åŒ–)
["ç”¨äºæ²»ç–—Aå’ŒB..."]     â†’   ["ç–¾ç—…A", "ç–¾ç—…B"]
                              â†‘
                           ç²¾ç¡®åŒ¹é…å‹å¥½
```

### 3. èŒè´£æ¸…æ™°åˆ†ç¦»

```
indication_match (è§„åˆ™)  â†’  is_offlabelåˆ¤æ–­
open_evidence (AI)      â†’  è¾…åŠ©å†³ç­–ä¿¡æ¯
recommendation         â†’  ç»¼åˆå»ºè®®
```

## æŠ€æœ¯æ ˆ

- **è¯­è¨€**: Python 3.12
- **LLM**: DeepSeek API
- **æ•°æ®åº“**: Elasticsearch 8.11
- **æ¡†æ¶**: FastAPI
- **éƒ¨ç½²**: Docker Compose

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| å•æ¬¡åˆ†ææ—¶é—´ | 5-8ç§’ |
| ESæŸ¥è¯¢å“åº” | < 100ms |
| å®ä½“è¯†åˆ«å‡†ç¡®ç‡ | > 95% |
| è¶…é€‚åº”ç—‡åˆ¤æ–­å‡†ç¡®ç‡ | > 85% |
| å¹¶å‘æ”¯æŒ | 10+ è¯·æ±‚ |

## æœªæ¥ä¼˜åŒ–

### çŸ­æœŸ
- âœ… åˆ¤æ–­é€»è¾‘ä¸¥æ ¼åŒ–
- âœ… indications_listç»“æ„åŒ–
- â³ æ‰©å¤§è¦†ç›–ç‡ï¼ˆ67.9k â†’ å…¨é‡ï¼‰

### ä¸­æœŸ
- ğŸš§ ä¸´åºŠæŒ‡å—é›†æˆ
- ğŸš§ ä¸“å®¶å…±è¯†é›†æˆ  
- ğŸš§ ç ”ç©¶æ–‡çŒ®é›†æˆ

### é•¿æœŸ
- ğŸ”® å‘é‡æ£€ç´¢ï¼ˆpgvectorï¼‰
- ğŸ”® å¤šæ¨¡æ€æ•°æ®æ”¯æŒ
- ğŸ”® å®æ—¶å­¦ä¹ æœºåˆ¶
