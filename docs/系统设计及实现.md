# åŒ»ç–—è¶…é€‚åº”ç—‡æ™ºèƒ½åˆ†æç³»ç»Ÿ - è®¾è®¡ä¸å®ç°

## ç³»ç»Ÿæ€»ä½“æ¶æ„

### æ¶æ„å›¾

```mermaid
graph TB
    A[åŒ»ç–—æ–‡æœ¬è¾“å…¥] --> B[æ¨ç†å¼•æ“ InferenceEngine]
    
    B --> B1[å®ä½“è¯†åˆ«æ¨¡å—]
    B --> B2[çŸ¥è¯†å¢å¼ºæ¨¡å—]
    B --> B3[åˆ†æåˆ¤æ–­æ¨¡å—]
    
    B1 --> ES[(Elasticsearch)]
    B2 --> ES
    B3 --> ES
    
    ES --> ES1[è¯å“ç´¢å¼•<br/>67.9k indications_list]
    ES --> ES2[ç–¾ç—…ç´¢å¼•<br/>108k diseases]
    
    B3 --> C[è¾“å‡ºå±‚]
    C --> C1[is_offlabel: è¶…é€‚åº”ç—‡åˆ¤æ–­]
    C --> C2[indication_match: è§„åˆ™åˆ¤æ–­]
    C --> C3[open_evidence: AIè¾…åŠ©]
    C --> C4[recommendation: ç”¨è¯å»ºè®®]
    
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#9cf,stroke:#333,stroke-width:2px
    style ES fill:#ffd,stroke:#333,stroke-width:2px
    style C fill:#9ff,stroke:#333,stroke-width:2px
```

## Inference æ¨¡å—è¯¦ç»†è®¾è®¡

### æ¨¡å—ç»„æˆ

```
app/inference/
â”œâ”€â”€ engine.py              # æ¨ç†å¼•æ“ï¼ˆæ€»æ§åˆ¶å™¨ï¼‰
â”œâ”€â”€ entity_matcher.py      # å®ä½“è¯†åˆ«
â”œâ”€â”€ knowledge_retriever.py # çŸ¥è¯†å¢å¼º
â”œâ”€â”€ rule_checker.py        # è§„åˆ™åˆ†æ
â”œâ”€â”€ llm_reasoner.py        # LLMæ¨ç†
â”œâ”€â”€ result_synthesizer.py  # ç»“æœç»¼åˆ
â”œâ”€â”€ result_generator.py    # ç»“æœç”Ÿæˆ
â”œâ”€â”€ models.py              # æ•°æ®æ¨¡å‹
â””â”€â”€ prompt.py              # Promptæ¨¡æ¿
```

### æ¨¡å—å…³ç³»å›¾

```mermaid
graph TB
    Engine[InferenceEngine<br/>engine.py]
    
    Entity[EntityRecognizer<br/>entity_matcher.py]
    Indication[IndicationAnalyzer<br/>llm_reasoner.py]
    
    Knowledge[KnowledgeEnhancer<br/>knowledge_retriever.py]
    Rule[RuleAnalyzer<br/>rule_checker.py]
    Synthesizer[ResultSynthesizer<br/>result_synthesizer.py]
    Generator[ResultGenerator<br/>result_generator.py]
    
    Models[models.py<br/>æ•°æ®æ¨¡å‹]
    Prompt[prompt.py<br/>Promptæ¨¡æ¿]
    
    Engine --> Entity
    Engine --> Indication
    
    Indication --> Knowledge
    Indication --> Rule
    Indication --> Synthesizer
    
    Entity --> Models
    Indication --> Models
    Indication --> Prompt
    
    Synthesizer --> Generator
    Engine --> Generator
    
    style Engine fill:#9cf,stroke:#333,stroke-width:3px
    style Entity fill:#fcf,stroke:#333,stroke-width:2px
    style Indication fill:#fcf,stroke:#333,stroke-width:2px
    style Synthesizer fill:#ffc,stroke:#333,stroke-width:2px
```

### å®Œæ•´å·¥ä½œæµç¨‹

```mermaid
graph TB
    A[è¾“å…¥æ•°æ®] --> B[EntityRecognizer]
    
    B -->|LLMæå–| B1[è¯å“/ç–¾ç—…å]
    B1 -->|ESæŸ¥è¯¢| B2[æ ‡å‡†åŒ–å®ä½“]
    
    B2 --> C[Caseç—…ä¾‹å¯¹è±¡]
    C --> D[KnowledgeEnhancer]
    
    D -->|ESæŸ¥è¯¢| D1[è¯å“ä¿¡æ¯]
    D1 -->|indications_list| D2[ç»“æ„åŒ–é€‚åº”ç—‡]
    D2 --> D3[EnhancedCase]
    
    D3 --> E[RuleAnalyzer]
    E -->|ç²¾ç¡®åŒ¹é…| E1[confidence: 1.0/0.0]
    
    D3 --> F[LLM Reasoner]
    F -->|æœºåˆ¶åˆ†æ| F1[mechanism_similarity]
    F -->|è¯æ®è¯„ä¼°| F2[evidence_support]
    
    E1 --> G[ResultSynthesizer]
    F1 --> G
    F2 --> G
    
    G -->|è§„åˆ™åˆ¤æ–­| G1[is_offlabel]
    G -->|AIè¾…åŠ©| G2[open_evidence]
    G -->|ç»¼åˆå»ºè®®| G3[recommendation]
    
    G1 --> H[ResultGenerator]
    G2 --> H
    G3 --> H
    
    H --> I[æœ€ç»ˆç»“æœ]
    
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style I fill:#9ff,stroke:#333,stroke-width:2px
    style E fill:#ff9,stroke:#333,stroke-width:2px
    style F fill:#ff9,stroke:#333,stroke-width:2px
    style G fill:#f99,stroke:#333,stroke-width:2px
```

## æ ¸å¿ƒæ¨¡å—è¯´æ˜

### 1. engine.py - æ¨ç†å¼•æ“

**èŒè´£**ï¼šæ€»æ§åˆ¶å™¨ï¼Œåè°ƒæ‰€æœ‰åˆ†ææ­¥éª¤

**ä¸»è¦ç±»**ï¼š`InferenceEngine`

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```python
def analyze(input_data) -> Dict:
    """å•ä¾‹åˆ†æ"""
    # 1. å®ä½“è¯†åˆ«
    entities = self.entity_recognizer.recognize(input_data)
    
    # 2. åˆ›å»ºç—…ä¾‹
    case = Case(id=..., recognized_entities=entities)
    
    # 3. é€‚åº”ç—‡åˆ†æ
    synthesis_result = self.indication_analyzer.analyze_indication(case)
    
    # 4. ç”Ÿæˆç»“æœ
    final_result = self.result_generator.generate(case, synthesis_result)
    
    return final_result

def analyze_batch(input_data_list) -> List[Dict]:
    """æ‰¹é‡åˆ†æ"""
    return [self.analyze(data) for data in input_data_list]
```

---

### 2. entity_matcher.py - å®ä½“è¯†åˆ«

**èŒè´£**ï¼šè¯†åˆ«è¯å“å’Œç–¾ç—…å®ä½“ï¼Œå¹¶ä¸ESæ•°æ®åº“å¯¹é½

**ä¸»è¦ç±»**ï¼š`EntityRecognizer`

**åŒé‡éªŒè¯æœºåˆ¶**ï¼š
```python
# 1. LLMæå–
è¾“å…¥: "æ°¢åŒ–å¯çš„æ¾"
LLMè¯†åˆ«: {"drugs": [{"name": "æ°¢åŒ–å¯çš„æ¾"}], ...}

# 2. ESéªŒè¯å¯¹é½
ESæŸ¥è¯¢: match{"name": "æ°¢åŒ–å¯çš„æ¾"}
ESè¿”å›: "æ°¢åŒ–å¯çš„æ¾ç‰‡" (ID: caa26d34...)

# 3. æ ‡å‡†åŒ–è¾“å‡º
RecognizedDrug(
    name="æ°¢åŒ–å¯çš„æ¾",
    matches=[DrugMatch(
        id="caa26d34...",
        standard_name="æ°¢åŒ–å¯çš„æ¾ç‰‡",
        score=16.18
    )]
)
```

**å…³é”®ç‰¹æ€§**ï¼š
- åˆ†å±‚æœç´¢ç­–ç•¥ï¼ˆç²¾ç¡® â†’ æ¨¡ç³Šï¼‰
- ç–¾ç—…åŒ¹é…ä¸¥æ ¼åŒ–ï¼ˆé¿å…é”™è¯¯åŒ¹é…ï¼‰
- æ”¯æŒæ— ESåŒ¹é…æ—¶ä½¿ç”¨LLMåŸå§‹åç§°

---

### 3. knowledge_retriever.py - çŸ¥è¯†å¢å¼º

**èŒè´£**ï¼šä»ESè·å–å®Œæ•´çš„è¯å“å’Œç–¾ç—…ä¿¡æ¯

**ä¸»è¦ç±»**ï¼š`KnowledgeEnhancer`

**å¢å¼ºæµç¨‹**ï¼š
```python
Case â†’ enhance_case()
    â”œâ”€ get_drug_by_id() â†’ è¯å“è¯¦ç»†ä¿¡æ¯
    â”‚   â”œâ”€ indications_list âœ¨ (ä¼˜å…ˆ)
    â”‚   â”œâ”€ contraindications
    â”‚   â””â”€ pharmacology
    â”œâ”€ get_disease_by_id() â†’ ç–¾ç—…è¯¦ç»†ä¿¡æ¯
    â””â”€ _gather_evidence() â†’ ä¸´åºŠè¯æ®
```

**å…³é”®åˆ›æ–°**ï¼š
```python
# ä¼˜å…ˆä½¿ç”¨ç»“æ„åŒ–åˆ—è¡¨
if indications_list:
    drug_info.indications = indications_list  # ["ç–¾ç—…A", "ç–¾ç—…B"]
else:
    drug_info.indications = indications       # ["é•¿å¥æè¿°..."]
```

---

### 4. rule_checker.py - è§„åˆ™åˆ†æ

**èŒè´£**ï¼šåŸºäºè§„åˆ™çš„è¶…é€‚åº”ç—‡åˆ¤æ–­

**ä¸»è¦ç±»**ï¼š`RuleAnalyzer`

**ä¸¥æ ¼åˆ¤æ–­é€»è¾‘**ï¼š
```python
def exact_match(drug_info, disease_info):
    """ç²¾ç¡®å­—ç¬¦ä¸²åŒ¹é…"""
    disease_name = disease_info["name"].lower()
    indications = drug_info["indications"]  # indications_list
    
    for indication in indications:
        if disease_name == indication.lower():  # å®Œå…¨ç›¸ç­‰
            return confidence=1.0
    
    return confidence=0.0

# ç¤ºä¾‹
é€‚åº”ç—‡: ["å…ˆå¤©æ€§è‚¾ä¸Šè…ºçš®è´¨å¢ç”Ÿç—‡", "è‚¾ä¸Šè…ºçš®è´¨åŠŸèƒ½å‡é€€ç—‡"]
æ‚£è€…: "21-ç¾ŸåŒ–é…¶ç¼ºä¹ç—‡"
åˆ¤æ–­: NOT IN åˆ—è¡¨ â†’ confidence=0.0 â†’ is_offlabel=True âœ…
```

**åˆ¤æ–­ç»´åº¦**ï¼š
- `exact_match()` - ç²¾ç¡®åŒ¹é…ï¼ˆconfidence=1.0ï¼‰
- `synonym_match()` - åŒä¹‰è¯ï¼ˆconfidence=0.9ï¼‰
- `hierarchy_match()` - å±‚çº§ï¼ˆconfidence=0.8ï¼‰

---

### 5. llm_reasoner.py - LLMæ¨ç†

**èŒè´£**ï¼šä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹è¿›è¡Œæ·±åº¦åˆ†æ

**ä¸»è¦ç±»**ï¼š`IndicationAnalyzer`

**åˆ†æå†…å®¹**ï¼š
```python
# 1. è§„åˆ™åˆ†æç»“æœreview
rule_result = {
    "is_offlabel": True,
    "confidence": 0.0,
    "reasoning": ["æœªåœ¨é€‚åº”ç—‡åˆ—è¡¨ä¸­ç²¾ç¡®åŒ¹é…"]
}

# 2. LLMæ·±åº¦åˆ†æ
llm_result = {
    "mechanism_similarity": {
        "score": 0.9,
        "reasoning": "21-ç¾ŸåŒ–é…¶ç¼ºä¹ç—‡æ˜¯å…ˆå¤©æ€§è‚¾ä¸Šè…ºçš®è´¨å¢ç”Ÿç—‡çš„äºšå‹"
    },
    "evidence_support": {
        "level": "D",
        "description": "åŸºäºæœºåˆ¶ç›¸ä¼¼æ€§æ¨æµ‹"
    }
}
```

**Promptçº¦æŸ**ï¼š
- é€‚åº”ç—‡åŒ¹é…åªåšå­—ç¬¦ä¸²åŒ¹é…ï¼Œä¸åšåŒ»å­¦æ¨ç†
- mechanism_similarityä»…ä½œå‚è€ƒï¼Œä¸å½±å“is_offlabel

---

### 6. result_synthesizer.py - ç»“æœç»¼åˆ

**èŒè´£**ï¼šç»¼åˆè§„åˆ™åˆ†æå’ŒLLMåˆ†æï¼Œç”Ÿæˆæœ€ç»ˆåˆ¤æ–­

**ä¸»è¦ç±»**ï¼š`ResultSynthesizer`

**åˆ¤æ–­é€»è¾‘ï¼ˆä¸¥æ ¼ï¼‰**ï¼š
```python
def _determine_final_offlabel_status(rule_result, llm_result, scores):
    """åªæœ‰ç²¾ç¡®åŒ¹é…æ‰åˆ¤å®šä¸ºéè¶…é€‚åº”ç—‡"""
    if not rule_result["is_offlabel"]:
        if rule_result["confidence"] >= 1.0:  # ç²¾ç¡®åŒ¹é…
            return False  # æ ‡å‡†ç”¨è¯
    return True  # è¶…é€‚åº”ç—‡
```

**è¾“å‡ºç»“æ„**ï¼š
```json
{
  "is_offlabel": true,              // è§„åˆ™åˆ¤æ–­
  "analysis_details": {
    "indication_match": {           // è§„åˆ™ä¾æ®
      "score": 0.0,
      "reasoning": "æœªåœ¨åˆ—è¡¨ä¸­ç²¾ç¡®åŒ¹é…"
    },
    "open_evidence": {              // AIè¾…åŠ©
      "mechanism_similarity": {...},
      "evidence_support": {...}
    },
    "recommendation": {...}
  },
  "metadata": {...}
}
```

---

### 7. result_generator.py - ç»“æœç”Ÿæˆ

**èŒè´£**ï¼šç”Ÿæˆæœ€ç»ˆçš„æ ‡å‡†åŒ–è¾“å‡º

**ä¸»è¦ç±»**ï¼š`ResultGenerator`

**åŠŸèƒ½**ï¼š
- æ•´åˆæ‰€æœ‰åˆ†æç»“æœ
- æ ¼å¼åŒ–è¾“å‡º
- æ”¯æŒæ–°æ—§ç»“æ„ï¼ˆå‘åå…¼å®¹ï¼‰

---

### 8. models.py - æ•°æ®æ¨¡å‹

**èŒè´£**ï¼šå®šä¹‰æ‰€æœ‰æ•°æ®ç»“æ„

**æ ¸å¿ƒæ¨¡å‹**ï¼š
```python
@dataclass
class RecognizedEntities:
    drugs: List[RecognizedDrug]
    diseases: List[RecognizedDisease]
    context: Context

@dataclass  
class EnhancedCase:
    drug: DrugInfo
    disease: DiseaseInfo
    evidence: Evidence

@dataclass
class AnalysisResult:
    case_id: str
    drug_info: DrugInfo
    disease_info: DiseaseInfo
    is_offlabel: bool
    analysis_details: AnalysisDetails
    metadata: Dict
```

---

### 9. prompt.py - Promptæ¨¡æ¿

**èŒè´£**ï¼šLLMçš„promptæ¨¡æ¿

**å…³é”®æ¨¡æ¿**ï¼š
- `create_entity_recognition_prompt()` - å®ä½“è¯†åˆ«
- `create_indication_analysis_prompt()` - é€‚åº”ç—‡åˆ†æ

**çº¦æŸè®¾è®¡**ï¼š
- è¦æ±‚LLMåªåšå­—ç¬¦ä¸²åŒ¹é…åˆ¤æ–­
- æœºåˆ¶åˆ†æä»…ä½œå‚è€ƒï¼Œä¸å½±å“is_offlabel

---

## æ•°æ®æµè½¬å›¾

```mermaid
sequenceDiagram
    participant Input as è¾“å…¥æ•°æ®
    participant Entity as EntityRecognizer
    participant ES as Elasticsearch
    participant Case as Caseå¯¹è±¡
    participant Knowledge as KnowledgeEnhancer
    participant Rule as RuleAnalyzer
    participant LLM as LLM Reasoner
    participant Synth as ResultSynthesizer
    participant Gen as ResultGenerator
    participant Output as æœ€ç»ˆç»“æœ
    
    Input->>Entity: 1. å®ä½“è¯†åˆ«
    Entity->>ES: LLMæå–åæŸ¥è¯¢
    ES-->>Entity: æ ‡å‡†åŒ–å®ä½“
    Entity->>Case: åˆ›å»ºç—…ä¾‹
    
    Case->>Knowledge: 2. çŸ¥è¯†å¢å¼º
    Knowledge->>ES: è·å–è¯å“/ç–¾ç—…ä¿¡æ¯
    ES-->>Knowledge: indications_listç­‰
    Knowledge-->>Case: EnhancedCase
    
    Case->>Rule: 3. è§„åˆ™åˆ†æ
    Rule-->>Synth: confidence: 1.0/0.0
    
    Case->>LLM: 4. LLMæ¨ç†
    LLM-->>Synth: mechanism + evidence
    
    Synth->>Synth: 5. ç»¼åˆåˆ¤æ–­
    Note over Synth: is_offlabel = (confidence<1.0)
    
    Synth->>Gen: synthesis_result
    Gen->>Output: æ ¼å¼åŒ–è¾“å‡º
```

## æ ¸å¿ƒæŠ€æœ¯å®ç°

### 1. å®ä½“è¯†åˆ«ä¸æ ‡å‡†åŒ–

**åŒé‡éªŒè¯æœºåˆ¶**ï¼š

```mermaid
graph LR
    A[åŸå§‹æ–‡æœ¬] --> B[LLMæå–]
    B --> C{ESéªŒè¯}
    C -->|æ‰¾åˆ°| D[æ ‡å‡†åŒ–å®ä½“]
    C -->|æœªæ‰¾åˆ°| E[ä¿ç•™LLMè¯†åˆ«]
    D --> F[RecognizedEntities]
    E --> F
```

**ä»£ç å®ç°**ï¼š
```python
# entity_matcher.py
def recognize(input_data):
    # 1. LLMæå–
    llm_result = llm.extract_entities(input_data)
    
    # 2. ESéªŒè¯
    for drug in llm_result['drugs']:
        matches = es.search(index='drugs', query=drug['name'])
        drug['matches'] = matches  # æ ‡å‡†åŒ–
    
    return RecognizedEntities(drugs=..., diseases=...)
```

---

### 2. çŸ¥è¯†å¢å¼º

**çŸ¥è¯†æ¥æºå±‚æ¬¡**ï¼š

```mermaid
graph TB
    Case[ç—…ä¾‹æ•°æ®] --> KE[KnowledgeEnhancer]
    
    KE --> L1[åŸºç¡€çŸ¥è¯†å±‚]
    L1 --> L1A[è¯å“è¯´æ˜ä¹¦]
    L1 --> L1B[ç–¾ç—…åˆ†ç±»]
    
    KE --> L2[ä¸´åºŠæŒ‡å—å±‚]
    L2 --> L2A[è¯Šç–—æŒ‡å—]
    L2 --> L2B[ä¸“å®¶å…±è¯†]
    
    KE --> L3[å¾ªè¯åŒ»å­¦å±‚]
    L3 --> L3A[RCTç ”ç©¶]
    L3 --> L3B[çœŸå®ä¸–ç•Œè¯æ®]
    
    L1A --> EC[EnhancedCase]
    L1B --> EC
    L2A -.-> EC
    L2B -.-> EC
    L3A -.-> EC
    L3B -.-> EC
    
    style L1 fill:#9cf
    style L2 fill:#fcf
    style L3 fill:#ffc
```

**ä»£ç å®ç°**ï¼š
```python
# knowledge_retriever.py
def enhance_case(case):
    enhanced = EnhancedCase(case)
    
    # è·å–è¯å“ä¿¡æ¯ï¼ˆä¼˜å…ˆindications_listï¼‰
    drug_data = es.get(index='drugs', id=drug_id)
    enhanced.drug.indications = drug_data.get('indications_list') or \
                                drug_data.get('indications')
    
    # è·å–è¯æ®ï¼ˆTODOï¼‰
    enhanced.evidence.clinical_guidelines = []
    enhanced.evidence.expert_consensus = []
    
    return enhanced
```

---

### 3. è§„åˆ™åˆ†æ

**åˆ¤æ–­æµç¨‹**ï¼š

```mermaid
graph TB
    A[è¯å“é€‚åº”ç—‡åˆ—è¡¨] --> B{ç²¾ç¡®åŒ¹é…?}
    C[æ‚£è€…ç–¾ç—…] --> B
    
    B -->|å®Œå…¨ç›¸ç­‰| D[confidence=1.0]
    B -->|ä¸åœ¨åˆ—è¡¨| E[confidence=0.0]
    
    D --> F[is_offlabel=False]
    E --> G[is_offlabel=True]
    
    F --> H[æ ‡å‡†ç”¨è¯]
    G --> I[è¶…é€‚åº”ç—‡]
    
    style D fill:#9f9
    style E fill:#f99
    style H fill:#9f9
    style I fill:#f99
```

**ç¤ºä¾‹**ï¼š
```python
# æ¡ˆä¾‹ï¼š21-ç¾ŸåŒ–é…¶ç¼ºä¹ç—‡ + æ°¢åŒ–å¯çš„æ¾
indications_list = ["å…ˆå¤©æ€§è‚¾ä¸Šè…ºçš®è´¨å¢ç”Ÿç—‡", "è‚¾ä¸Šè…ºçš®è´¨åŠŸèƒ½å‡é€€ç—‡"]
disease_name = "21-ç¾ŸåŒ–é…¶ç¼ºä¹ç—‡"

# åˆ¤æ–­
"21-ç¾ŸåŒ–é…¶ç¼ºä¹ç—‡" NOT IN indications_list
â†’ confidence = 0.0
â†’ is_offlabel = True âœ…
```

---

### 4. LLMæ¨ç†

**åˆ†æç»´åº¦**ï¼š

```mermaid
graph TB
    EC[EnhancedCase] --> LLM[LLM Reasoner]
    
    LLM --> A1[é€‚åº”ç—‡åŒ¹é…]
    LLM --> A2[æœºåˆ¶ç›¸ä¼¼æ€§]
    LLM --> A3[è¯æ®æ”¯æŒ]
    LLM --> A4[é£é™©è¯„ä¼°]
    
    A1 --> R[LLM Result]
    A2 --> R
    A3 --> R
    A4 --> R
    
    style LLM fill:#fcf
    style R fill:#ffc
```

**Promptè®¾è®¡**ï¼š
```
ã€é‡è¦çº¦æŸã€‘
- é€‚åº”ç—‡åŒ¹é…åªåšå­—ç¬¦ä¸²æ¯”å¯¹ï¼Œä¸åšåŒ»å­¦æ¨ç†
- å³ä½¿åŒ»å­¦ä¸Šç›¸å…³ï¼Œå­—ç¬¦ä¸²ä¸åŒ¹é…å°±æ˜¯ä¸åŒ¹é…
- mechanism_similarityä½œä¸ºå‚è€ƒï¼Œä¸å½±å“is_offlabel

ã€åˆ†æå†…å®¹ã€‘
1. indication_match: å­—ç¬¦ä¸²åŒ¹é…ç»“æœ
2. mechanism_similarity: è¯ç†æœºåˆ¶åˆ†æï¼ˆAIè¾…åŠ©ï¼‰
3. evidence_support: è¯æ®ç­‰çº§è¯„ä¼°
```

---

### 5. ç»“æœç»¼åˆ

**ç»¼åˆå†³ç­–æµç¨‹**ï¼š

```mermaid
graph TB
    Rule[è§„åˆ™åˆ†æç»“æœ] --> Synth[ResultSynthesizer]
    LLM[LLMåˆ†æç»“æœ] --> Synth
    Evidence[çŸ¥è¯†è¯æ®] --> Synth
    
    Synth --> D{confidence?}
    
    D -->|=1.0| E[is_offlabel=False]
    D -->|<1.0| F[is_offlabel=True]
    
    E --> G[æ ‡å‡†ç”¨è¯]
    F --> H[è¶…é€‚åº”ç—‡]
    
    LLM --> I[open_evidence]
    I --> J[mechanism_similarity]
    I --> K[evidence_support]
    
    G --> L[æœ€ç»ˆè¾“å‡º]
    H --> L
    J --> L
    K --> L
    
    style D fill:#ff9,stroke:#333,stroke-width:2px
    style E fill:#9f9
    style F fill:#f99
    style I fill:#fcf
```

**å…³é”®ä»£ç **ï¼š
```python
# result_synthesizer.py
def _determine_final_offlabel_status(rule_result, llm_result, scores):
    """ä¸¥æ ¼åˆ¤æ–­ï¼šåªæœ‰ç²¾ç¡®åŒ¹é…æ‰æ˜¯éè¶…é€‚åº”ç—‡"""
    if not rule_result["is_offlabel"]:
        if rule_result["confidence"] >= 1.0:
            return False  # æ ‡å‡†ç”¨è¯
    return True  # è¶…é€‚åº”ç—‡
```

---

## æ•°æ®å±‚è®¾è®¡

### Elasticsearchç´¢å¼•ç»“æ„

```mermaid
erDiagram
    DRUGS ||--o{ INDICATIONS_LIST : contains
    DRUGS ||--o{ CONTRAINDICATIONS : contains
    DISEASES ||--o{ CATEGORIES : belongs_to
    
    DRUGS {
        string id PK
        string name
        array indications_list
        array contraindications
        object details
    }
    
    INDICATIONS_LIST {
        string disease_name
    }
    
    DISEASES {
        string id PK
        string name
        string category
        string icd_code
    }
```

### æ•°æ®ç»Ÿè®¡

| ç´¢å¼• | è§„æ¨¡ | å…³é”®å­—æ®µ |
|------|------|----------|
| drugs | 1,953,754 | name, indications_list |
| diseases | 108,660 | name, category |
| indications_list | 67,939è¯å“ | ç»“æ„åŒ–ç–¾ç—…åˆ—è¡¨ âœ¨ |

---

## è¾“å‡ºæ ¼å¼

### å®Œæ•´è¾“å‡ºç»“æ„

```json
{
  "case_id": "1761791123.598409",
  "analysis_time": "2025-10-30T10:25:43",
  
  "drug_info": {
    "id": "caa26d34...",
    "name": "æ°¢åŒ–å¯çš„æ¾",
    "standard_name": "æ°¢åŒ–å¯çš„æ¾ç‰‡"
  },
  
  "disease_info": {
    "id": null,
    "name": "21-ç¾ŸåŒ–é…¶ç¼ºä¹ç—‡",
    "standard_name": null
  },
  
  "is_offlabel": true,  // è§„åˆ™åˆ¤æ–­ï¼šä¸¥æ ¼
  
  "analysis_details": {
    "indication_match": {  // è§„åˆ™åˆ¤æ–­ä¾æ®
      "score": 0.0,
      "matching_indication": "æ— ",
      "reasoning": "æ‚£è€…è¯Šæ–­'21-ç¾ŸåŒ–é…¶ç¼ºä¹ç—‡'æœªç²¾ç¡®å‡ºç°åœ¨é€‚åº”ç—‡åˆ—è¡¨['å…ˆå¤©æ€§è‚¾ä¸Šè…ºçš®è´¨å¢ç”Ÿç—‡', 'è‚¾ä¸Šè…ºçš®è´¨åŠŸèƒ½å‡é€€ç—‡']ä¸­"
    },
    
    "open_evidence": {  // AIè¾…åŠ©ä¿¡æ¯
      "mechanism_similarity": {
        "score": 0.9,
        "reasoning": "21-ç¾ŸåŒ–é…¶ç¼ºä¹ç—‡æ˜¯å…ˆå¤©æ€§è‚¾ä¸Šè…ºçš®è´¨å¢ç”Ÿç—‡çš„äºšå‹ï¼Œè¯ç†æœºåˆ¶é«˜åº¦ç›¸å…³"
      },
      "evidence_support": {
        "level": "D",
        "clinical_guidelines": [],
        "expert_consensus": [],
        "research_papers": [],
        "description": "åŸºäºè¯ç†æœºåˆ¶ç›¸ä¼¼æ€§æ¨æµ‹"
      }
    },
    
    "recommendation": {
      "decision": "è°¨æ…ä½¿ç”¨",
      "explanation": "è™½ç„¶å±äºè¶…é€‚åº”ç—‡ç”¨è¯ï¼Œä½†æœ‰ä¸€å®šçš„è¯æ®æ”¯æŒå…¶åˆç†æ€§",
      "risk_assessment": "éœ€ç›‘æµ‹ä¸è‰¯ååº”"
    }
  },
  
  "metadata": {
    "rule_confidence": 0.0,
    "llm_confidence": 0.3,
    "evidence_sources": []
  }
}
```

---

## å…³é”®è®¾è®¡å†³ç­–

### 1. åˆ¤æ–­é€»è¾‘ä¸¥æ ¼åŒ–

```mermaid
graph LR
    A[è¶…é€‚åº”ç—‡å®šä¹‰] --> B[è¯å“ç”¨äºè¯´æ˜ä¹¦<br/>æœªæ‰¹å‡†çš„é€‚åº”ç—‡]
    B --> C[åˆ¤æ–­æ ‡å‡†]
    C --> D[ä¸¥æ ¼å­—ç¬¦ä¸²<br/>ç²¾ç¡®åŒ¹é…]
    D --> E[ç³»ç»Ÿå®šä½]
    E --> E1[è§„åˆ™åˆ¤æ–­: ç¡®å®šæ€§]
    E --> E2[AIè¾…åŠ©: å‚è€ƒæ€§]
```

### 2. æ•°æ®ç»“æ„ä¼˜åŒ–

```
åŸå§‹æ ¼å¼ (indications)
["ä¸»è¦ç”¨äºæ²»ç–—è‚¾ä¸Šè…ºçš®è´¨åŠŸèƒ½å‡é€€ç—‡çš„æ›¿ä»£æ²»ç–—åŠå…ˆå¤©æ€§è‚¾ä¸Šè…ºçš®è´¨å¢ç”Ÿç—‡"]
                    â†“ LLMæå–
ä¼˜åŒ–æ ¼å¼ (indications_list)
["è‚¾ä¸Šè…ºçš®è´¨åŠŸèƒ½å‡é€€ç—‡", "å…ˆå¤©æ€§è‚¾ä¸Šè…ºçš®è´¨å¢ç”Ÿç—‡"]
                    â†“
          é€‚åˆç²¾ç¡®å­—ç¬¦ä¸²åŒ¹é… âœ¨
```

### 3. èŒè´£æ¸…æ™°åˆ†ç¦»

```mermaid
graph TB
    IM[indication_match<br/>è§„åˆ™åˆ¤æ–­] --> OF[is_offlabel]
    OE[open_evidence<br/>AIè¾…åŠ©] --> REF[å‚è€ƒä¿¡æ¯]
    REC[recommendation<br/>ç»¼åˆå»ºè®®] --> DEC[ä¸´åºŠå†³ç­–]
    
    OF --> OUT[æœ€ç»ˆè¾“å‡º]
    REF --> OUT
    DEC --> OUT
    
    style IM fill:#9f9
    style OE fill:#fcf
    style REC fill:#ff9
```

---

## æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ | ç‰ˆæœ¬ |
|------|------|------|
| è¯­è¨€ | Python | 3.12 |
| LLM | DeepSeek API | deepseek-chat |
| æ•°æ®åº“ | Elasticsearch | 8.11 |
| æ¡†æ¶ | FastAPI | Latest |
| éƒ¨ç½² | Docker Compose | - |

---

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| å•æ¬¡åˆ†ææ—¶é—´ | 5-8ç§’ | åŒ…å«LLMè°ƒç”¨ |
| ESæŸ¥è¯¢å“åº” | < 100ms | çŸ¥è¯†æ£€ç´¢ |
| å®ä½“è¯†åˆ«å‡†ç¡®ç‡ | > 95% | LLM + ES |
| åˆ¤æ–­å‡†ç¡®ç‡ | > 85% | è§„åˆ™ + AI |
| å¹¶å‘æ”¯æŒ | 10+ | åŒæ—¶è¯·æ±‚ |

---

## æœªæ¥ä¼˜åŒ–

### çŸ­æœŸï¼ˆå·²å®Œæˆï¼‰
- âœ… åˆ¤æ–­é€»è¾‘ä¸¥æ ¼åŒ–
- âœ… indications_listç»“æ„åŒ–ï¼ˆ67.9kï¼‰
- âœ… è¾“å‡ºç»“æ„æ¸…æ™°åŒ–

### ä¸­æœŸï¼ˆå¼€å‘ä¸­ï¼‰
- ğŸš§ ä¸´åºŠæŒ‡å—é›†æˆ
- ğŸš§ ä¸“å®¶å…±è¯†é›†æˆ
- ğŸš§ ç ”ç©¶æ–‡çŒ®é›†æˆ
- â³ æ‰©å¤§indications_listè¦†ç›–ï¼ˆâ†’ å…¨é‡ï¼‰

### é•¿æœŸï¼ˆè§„åˆ’ä¸­ï¼‰
- ğŸ”® å‘é‡æ£€ç´¢ï¼ˆpgvectorï¼‰
- ğŸ”® å¤šæ¨¡æ€æ•°æ®æ”¯æŒ
- ğŸ”® å®æ—¶å­¦ä¹ æœºåˆ¶
