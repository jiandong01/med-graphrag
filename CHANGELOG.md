# Changelog

## [Unreleased]

### 记录与规划 (2025-10-31)

#### 1. 实体匹配策略分析与优化
**现状分析**：
- 当前 `entity_matcher.py` 采用分步策略：
  1. 精确匹配：`term` (keyword) + `match_phrase`
  2. 模糊匹配：`match` (minimum_should_match=75%)
- **问题**：用户反馈特定疾病和用药检索出现误匹配，主要源于第二步的模糊匹配引入了噪声。

**优化方案**：
- **严格匹配 (Strict Mode)**：Elasticsearch 完全支持严格匹配。应利用 `term` 查询针对 `keyword` 类型字段进行精确查找。
- **改进计划**：
  - 移除或默认关闭药品的模糊匹配步骤。
  - 仅保留 `term` 查询和 `match_phrase` 查询，确保只有名称完全一致或短语完全包含时才匹配。
  - 对于别名支持，应通过 ES 的 `synonym` token filter 在索引侧解决，而不是通过模糊查询。

#### 2. 罕见病场景优化
**目标**：确保在罕见病上的识别效果，降低实体匹配的干扰。

**当前策略**：
- 双重验证：LLM 提取 -> ES 验证。
- Fallback 机制：如果 ES 中未找到匹配（Strict/Fuzzy），保留 LLM 提取的原始名称。

**优化建议**：
- **知识库改动**：
  - **引入罕见病专用词表**：集成 Orphanet 或 NORD 数据，建立罕见病名称及其同义词的映射。
  - **别名索引**：在 ES 索引中增加 `alias` 字段，或配置 `synonym_graph` 过滤器，确保罕见病的各种别名（如 "21-OHD" vs "21-羟化酶缺乏症"）能精确映射到标准实体 ID。
- **算法改动**：
  - **高优先级匹配**：建立罕见病白名单，对白名单内的疾病名称禁用任何形式的模糊纠错，强制精确匹配。
  - **向量检索 (Long-term)**：引入 `dense_vector` 检索，解决罕见病名称变体复杂导致的关键词匹配失效问题。

#### 3. 评测指标记录
**当前评测脚本** (`scripts/evaluate_results.py`) 使用以下指标：

- **基础指标**：
  - **混淆矩阵**：TP (真超适应症), TN (真标准用药), FP (误判为超适应症), FN (漏判超适应症)
  - **Accuracy**：整体准确率
  - **Precision**：查准率（判定为超适应症的准确性）
  - **Recall**：召回率（超适应症的检出率）
  - **F1-Score**：Precision 和 Recall 的调和平均

- **高级指标**：
  - **AUC-ROC**：ROC 曲线下面积，用于评估模型区分超适应症和标准用药的能力。
  - **Score 计算**：`score = 1.0 - rule_confidence` (规则置信度越低，超适应症可能性越高)。
